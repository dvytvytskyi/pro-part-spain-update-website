import{c as ur,u as xt,a as Ft,j as S,H as Rt}from"./index-OEqjzcPY.js";import{g as it,r as R,M as dr,S as fr,L as ze,P as pr}from"./mapbox-gl-Baw0grWs.js";/* empty css                  */import{b as hr}from"./client-DjafAzYx.js";import{u as gr,P as mr}from"./PropertyFilters-BUMZf7jt.js";import"./vendor-B3DjV561.js";import"./staticLocations-DyS3-l-A.js";/* empty css                          */import"./check-B9_4u16q.js";const yr=[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]],ht=ur("external-link",yr),Q={CANVAS:"mapboxgl-canvas",CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},ie={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},F={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},ee={POLYGON:"polygon",LINE:"line_string",POINT:"point"},C={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},_={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select"},X={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},Ie={MOVE:"move",CHANGE_PROPERTIES:"change_properties",CHANGE_COORDINATES:"change_coordinates"},J={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},$={ACTIVE:"true",INACTIVE:"false"},kt=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],Er=-90,Ke=-85,Cr=90,Ze=85,br=-270,Sr=270,Dt=Object.freeze(Object.defineProperty({__proto__:null,LAT_MAX:Cr,LAT_MIN:Er,LAT_RENDERED_MAX:Ze,LAT_RENDERED_MIN:Ke,LNG_MAX:Sr,LNG_MIN:br,activeStates:$,classes:Q,cursors:F,events:X,geojsonTypes:C,interactions:kt,meta:J,modes:_,sources:ie,types:ee,updateActions:Ie},Symbol.toStringTag,{value:"Module"}));function De(e){return function(t){const r=t.featureTarget;return!r||!r.properties?!1:r.properties.meta===e}}function Ut(e){return!e.originalEvent||!e.originalEvent.shiftKey?!1:e.originalEvent.button===0}function Ee(e){return!e.featureTarget||!e.featureTarget.properties?!1:e.featureTarget.properties.active===$.ACTIVE&&e.featureTarget.properties.meta===J.FEATURE}function st(e){return!e.featureTarget||!e.featureTarget.properties?!1:e.featureTarget.properties.active===$.INACTIVE&&e.featureTarget.properties.meta===J.FEATURE}function Ue(e){return e.featureTarget===void 0}function at(e){return!e.featureTarget||!e.featureTarget.properties?!1:e.featureTarget.properties.meta===J.FEATURE}function Me(e){const t=e.featureTarget;return!t||!t.properties?!1:t.properties.meta===J.VERTEX}function Re(e){return e.originalEvent?e.originalEvent.shiftKey===!0:!1}function Ge(e){return e.key==="Escape"||e.keyCode===27}function Ve(e){return e.key==="Enter"||e.keyCode===13}function Qe(e){return e.key==="Backspace"||e.keyCode===8}function et(e){return e.key==="Delete"||e.keyCode===46}function Gt(e){return e.key==="1"||e.keyCode===49}function Vt(e){return e.key==="2"||e.keyCode===50}function Bt(e){return e.key==="3"||e.keyCode===51}function $t(e){const t=e.key||String.fromCharCode(e.keyCode);return t>="0"&&t<="9"}function Tr(){return!0}const vr=Object.freeze(Object.defineProperty({__proto__:null,isActiveFeature:Ee,isBackspaceKey:Qe,isDeleteKey:et,isDigit1Key:Gt,isDigit2Key:Vt,isDigit3Key:Bt,isDigitKey:$t,isEnterKey:Ve,isEscapeKey:Ge,isFeature:at,isInactiveFeature:st,isOfMetaType:De,isShiftDown:Re,isShiftMousedown:Ut,isTrue:Tr,isVertex:Me,noTarget:Ue},Symbol.toStringTag,{value:"Module"}));var Pe={},_e={},gt;function _r(){return gt||(gt=1,_e.RADIUS=6378137,_e.FLATTENING=1/298.257223563,_e.POLAR_RADIUS=63567523142e-4),_e}var mt;function wr(){if(mt)return Pe;mt=1;var e=_r();Pe.geometry=t,Pe.ring=n;function t(o){var a=0,l;switch(o.type){case"Polygon":return r(o.coordinates);case"MultiPolygon":for(l=0;l<o.coordinates.length;l++)a+=r(o.coordinates[l]);return a;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(l=0;l<o.geometries.length;l++)a+=t(o.geometries[l]);return a}}function r(o){var a=0;if(o&&o.length>0){a+=Math.abs(n(o[0]));for(var l=1;l<o.length;l++)a-=Math.abs(n(o[l]))}return a}function n(o){var a,l,c,f,m,p,s,d=0,g=o.length;if(g>2){for(s=0;s<g;s++)s===g-2?(f=g-2,m=g-1,p=0):s===g-1?(f=g-1,m=0,p=1):(f=s,m=s+1,p=s+2),a=o[f],l=o[m],c=o[p],d+=(i(c[0])-i(a[0]))*Math.sin(i(l[1]));d=d*e.RADIUS*e.RADIUS/2}return d}function i(o){return o*Math.PI/180}return Pe}var Ir=wr();const Mr=it(Ir),yt={Point:0,LineString:1,MultiLineString:1,Polygon:2};function Or(e,t){const r=yt[e.geometry.type]-yt[t.geometry.type];return r===0&&e.geometry.type===C.POLYGON?e.area-t.area:r}function jt(e){return e.map(t=>(t.geometry.type===C.POLYGON&&(t.area=Mr.geometry({type:C.FEATURE,property:{},geometry:t.geometry})),t)).sort(Or).map(t=>(delete t.area,t))}function Jt(e,t=0){return[[e.point.x-t,e.point.y-t],[e.point.x+t,e.point.y+t]]}function se(e){if(this._items={},this._nums={},this._length=e?e.length:0,!!e)for(let t=0,r=e.length;t<r;t++)this.add(e[t]),e[t]!==void 0&&(typeof e[t]=="string"?this._items[e[t]]=t:this._nums[e[t]]=t)}se.prototype.add=function(e){return this.has(e)?this:(this._length++,typeof e=="string"?this._items[e]=this._length:this._nums[e]=this._length,this)};se.prototype.delete=function(e){return this.has(e)===!1?this:(this._length--,delete this._items[e],delete this._nums[e],this)};se.prototype.has=function(e){return typeof e!="string"&&typeof e!="number"?!1:this._items[e]!==void 0||this._nums[e]!==void 0};se.prototype.values=function(){const e=[];return Object.keys(this._items).forEach(t=>{e.push({k:t,v:this._items[t]})}),Object.keys(this._nums).forEach(t=>{e.push({k:JSON.parse(t),v:this._nums[t]})}),e.sort((t,r)=>t.v-r.v).map(t=>t.k)};se.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};const Nr=[J.FEATURE,J.MIDPOINT,J.VERTEX],Se={click:Lr,touch:Pr};function Lr(e,t,r){return qt(e,t,r,r.options.clickBuffer)}function Pr(e,t,r){return qt(e,t,r,r.options.touchBuffer)}function qt(e,t,r,n){if(r.map===null)return[];const i=e?Jt(e,n):t,o={};r.options.styles&&(o.layers=r.options.styles.map(f=>f.id).filter(f=>r.map.getLayer(f)!=null));const a=r.map.queryRenderedFeatures(i,o).filter(f=>Nr.indexOf(f.properties.meta)!==-1),l=new se,c=[];return a.forEach(f=>{const m=f.properties.id;l.has(m)||(l.add(m),c.push(f))}),jt(c)}function Fe(e,t){const r=Se.click(e,null,t),n={mouse:F.NONE};return r[0]&&(n.mouse=r[0].properties.active===$.ACTIVE?F.MOVE:F.POINTER,n.feature=r[0].properties.meta),t.events.currentModeName().indexOf("draw")!==-1&&(n.mouse=F.ADD),t.ui.queueMapClasses(n),t.ui.updateMapClasses(),r[0]}function lt(e,t){const r=e.x-t.x,n=e.y-t.y;return Math.sqrt(r*r+n*n)}const Ar=4,xr=12,Fr=500;function tt(e,t,r={}){const n=r.fineTolerance!=null?r.fineTolerance:Ar,i=r.grossTolerance!=null?r.grossTolerance:xr,o=r.interval!=null?r.interval:Fr;e.point=e.point||t.point,e.time=e.time||t.time;const a=lt(e.point,t.point);return a<n||a<i&&t.time-e.time<o}const Rr=25,kr=250;function rt(e,t,r={}){const n=r.tolerance!=null?r.tolerance:Rr,i=r.interval!=null?r.interval:kr;return e.point=e.point||t.point,e.time=e.time||t.time,lt(e.point,t.point)<n&&t.time-e.time<i}const nt=function(e,t){const r={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},n={on(o,a,l){if(r[o]===void 0)throw new Error(`Invalid event type: ${o}`);r[o].push({selector:a,fn:l})},render(o){t.store.featureChanged(o)}},i=function(o,a){const l=r[o];let c=l.length;for(;c--;){const f=l[c];if(f.selector(a)){f.fn.call(n,a)||t.store.render(),t.ui.updateMapClasses();break}}};return e.start.call(n),{render:e.render,stop(){e.stop&&e.stop()},trash(){e.trash&&(e.trash(),t.store.render())},combineFeatures(){e.combineFeatures&&e.combineFeatures()},uncombineFeatures(){e.uncombineFeatures&&e.uncombineFeatures()},drag(o){i("drag",o)},click(o){i("click",o)},mousemove(o){i("mousemove",o)},mousedown(o){i("mousedown",o)},mouseup(o){i("mouseup",o)},mouseout(o){i("mouseout",o)},keydown(o){i("keydown",o)},keyup(o){i("keyup",o)},touchstart(o){i("touchstart",o)},touchmove(o){i("touchmove",o)},touchend(o){i("touchend",o)},tap(o){i("tap",o)}}};let Dr=(e,t=21)=>(r=t)=>{let n="",i=r|0;for(;i--;)n+=e[Math.random()*e.length|0];return n};const Ur=Dr("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",32);function ct(){return Ur()}const W=function(e,t){this.ctx=e,this.properties=t.properties||{},this.coordinates=t.geometry.coordinates,this.id=t.id||ct(),this.type=t.geometry.type};W.prototype.changed=function(){this.ctx.store.featureChanged(this.id)};W.prototype.incomingCoords=function(e){this.setCoordinates(e)};W.prototype.setCoordinates=function(e){this.coordinates=e,this.changed()};W.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))};W.prototype.setProperty=function(e,t){this.properties[e]=t};W.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:C.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))};W.prototype.internal=function(e){const t={id:this.id,meta:J.FEATURE,"meta:type":this.type,active:$.INACTIVE,mode:e};if(this.ctx.options.userProperties)for(const r in this.properties)t[`user_${r}`]=this.properties[r];return{type:C.FEATURE,properties:t,geometry:{coordinates:this.getCoordinates(),type:this.type}}};const me=function(e,t){W.call(this,e,t)};me.prototype=Object.create(W.prototype);me.prototype.isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"};me.prototype.updateCoordinate=function(e,t,r){arguments.length===3?this.coordinates=[t,r]:this.coordinates=[e,t],this.changed()};me.prototype.getCoordinate=function(){return this.getCoordinates()};const fe=function(e,t){W.call(this,e,t)};fe.prototype=Object.create(W.prototype);fe.prototype.isValid=function(){return this.coordinates.length>1};fe.prototype.addCoordinate=function(e,t,r){this.changed();const n=parseInt(e,10);this.coordinates.splice(n,0,[t,r])};fe.prototype.getCoordinate=function(e){const t=parseInt(e,10);return JSON.parse(JSON.stringify(this.coordinates[t]))};fe.prototype.removeCoordinate=function(e){this.changed(),this.coordinates.splice(parseInt(e,10),1)};fe.prototype.updateCoordinate=function(e,t,r){const n=parseInt(e,10);this.coordinates[n]=[t,r],this.changed()};const oe=function(e,t){W.call(this,e,t),this.coordinates=this.coordinates.map(r=>r.slice(0,-1))};oe.prototype=Object.create(W.prototype);oe.prototype.isValid=function(){return this.coordinates.length===0?!1:this.coordinates.every(e=>e.length>2)};oe.prototype.incomingCoords=function(e){this.coordinates=e.map(t=>t.slice(0,-1)),this.changed()};oe.prototype.setCoordinates=function(e){this.coordinates=e,this.changed()};oe.prototype.addCoordinate=function(e,t,r){this.changed();const n=e.split(".").map(o=>parseInt(o,10));this.coordinates[n[0]].splice(n[1],0,[t,r])};oe.prototype.removeCoordinate=function(e){this.changed();const t=e.split(".").map(n=>parseInt(n,10)),r=this.coordinates[t[0]];r&&(r.splice(t[1],1),r.length<3&&this.coordinates.splice(t[0],1))};oe.prototype.getCoordinate=function(e){const t=e.split(".").map(n=>parseInt(n,10)),r=this.coordinates[t[0]];return JSON.parse(JSON.stringify(r[t[1]]))};oe.prototype.getCoordinates=function(){return this.coordinates.map(e=>e.concat([e[0]]))};oe.prototype.updateCoordinate=function(e,t,r){this.changed();const n=e.split("."),i=parseInt(n[0],10),o=parseInt(n[1],10);this.coordinates[i]===void 0&&(this.coordinates[i]=[]),this.coordinates[i][o]=[t,r]};const Gr={MultiPoint:me,MultiLineString:fe,MultiPolygon:oe},Be=(e,t,r,n,i)=>{const o=r.split("."),a=parseInt(o[0],10),l=o[1]?o.slice(1).join("."):null;return e[a][t](l,n,i)},Y=function(e,t){if(W.call(this,e,t),delete this.coordinates,this.model=Gr[t.geometry.type],this.model===void 0)throw new TypeError(`${t.geometry.type} is not a valid type`);this.features=this._coordinatesToFeatures(t.geometry.coordinates)};Y.prototype=Object.create(W.prototype);Y.prototype._coordinatesToFeatures=function(e){const t=this.model.bind(this);return e.map(r=>new t(this.ctx,{id:ct(),type:C.FEATURE,properties:{},geometry:{coordinates:r,type:this.type.replace("Multi","")}}))};Y.prototype.isValid=function(){return this.features.every(e=>e.isValid())};Y.prototype.setCoordinates=function(e){this.features=this._coordinatesToFeatures(e),this.changed()};Y.prototype.getCoordinate=function(e){return Be(this.features,"getCoordinate",e)};Y.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(e=>e.type===C.POLYGON?e.getCoordinates():e.coordinates)))};Y.prototype.updateCoordinate=function(e,t,r){Be(this.features,"updateCoordinate",e,t,r),this.changed()};Y.prototype.addCoordinate=function(e,t,r){Be(this.features,"addCoordinate",e,t,r),this.changed()};Y.prototype.removeCoordinate=function(e){Be(this.features,"removeCoordinate",e),this.changed()};Y.prototype.getFeatures=function(){return this.features};function v(e){this.map=e.map,this.drawConfig=JSON.parse(JSON.stringify(e.options||{})),this._ctx=e}v.prototype.setSelected=function(e){return this._ctx.store.setSelected(e)};v.prototype.setSelectedCoordinates=function(e){this._ctx.store.setSelectedCoordinates(e),e.reduce((t,r)=>(t[r.feature_id]===void 0&&(t[r.feature_id]=!0,this._ctx.store.get(r.feature_id).changed()),t),{})};v.prototype.getSelected=function(){return this._ctx.store.getSelected()};v.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()};v.prototype.isSelected=function(e){return this._ctx.store.isSelected(e)};v.prototype.getFeature=function(e){return this._ctx.store.get(e)};v.prototype.select=function(e){return this._ctx.store.select(e)};v.prototype.deselect=function(e){return this._ctx.store.deselect(e)};v.prototype.deleteFeature=function(e,t={}){return this._ctx.store.delete(e,t)};v.prototype.addFeature=function(e,t={}){return this._ctx.store.add(e,t)};v.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()};v.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()};v.prototype.setActionableState=function(e={}){const t={trash:e.trash||!1,combineFeatures:e.combineFeatures||!1,uncombineFeatures:e.uncombineFeatures||!1};return this._ctx.events.actionable(t)};v.prototype.changeMode=function(e,t={},r={}){return this._ctx.events.changeMode(e,t,r)};v.prototype.fire=function(e,t){return this._ctx.events.fire(e,t)};v.prototype.updateUIClasses=function(e){return this._ctx.ui.queueMapClasses(e)};v.prototype.activateUIButton=function(e){return this._ctx.ui.setActiveButton(e)};v.prototype.featuresAt=function(e,t,r="click"){if(r!=="click"&&r!=="touch")throw new Error("invalid buffer type");return Se[r](e,t,this._ctx)};v.prototype.newFeature=function(e){const t=e.geometry.type;return t===C.POINT?new me(this._ctx,e):t===C.LINE_STRING?new fe(this._ctx,e):t===C.POLYGON?new oe(this._ctx,e):new Y(this._ctx,e)};v.prototype.isInstanceOf=function(e,t){if(e===C.POINT)return t instanceof me;if(e===C.LINE_STRING)return t instanceof fe;if(e===C.POLYGON)return t instanceof oe;if(e==="MultiFeature")return t instanceof Y;throw new Error(`Unknown feature class: ${e}`)};v.prototype.doRender=function(e){return this._ctx.store.featureChanged(e)};v.prototype.onSetup=function(){};v.prototype.onDrag=function(){};v.prototype.onClick=function(){};v.prototype.onMouseMove=function(){};v.prototype.onMouseDown=function(){};v.prototype.onMouseUp=function(){};v.prototype.onMouseOut=function(){};v.prototype.onKeyUp=function(){};v.prototype.onKeyDown=function(){};v.prototype.onTouchStart=function(){};v.prototype.onTouchMove=function(){};v.prototype.onTouchEnd=function(){};v.prototype.onTap=function(){};v.prototype.onStop=function(){};v.prototype.onTrash=function(){};v.prototype.onCombineFeature=function(){};v.prototype.onUncombineFeature=function(){};v.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};const zt={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},Vr=Object.keys(zt);function Br(e){const t=Object.keys(e);return function(r,n={}){let i={};const o=t.reduce((l,c)=>(l[c]=e[c],l),new v(r));function a(l){return c=>o[l](i,c)}return{start(){i=o.onSetup(n),Vr.forEach(l=>{const c=zt[l];let f=()=>!1;e[c]&&(f=()=>!0),this.on(l,f,a(c))})},stop(){o.onStop(i)},trash(){o.onTrash(i)},combineFeatures(){o.onCombineFeatures(i)},uncombineFeatures(){o.onUncombineFeatures(i)},render(l,c){o.toDisplayFeatures(i,l,c)}}}}function $r(e){const t=Object.keys(e.options.modes).reduce((s,d)=>(s[d]=Br(e.options.modes[d]),s),{});let r={},n={};const i={};let o=null,a=null;i.drag=function(s,d){d({point:s.point,time:new Date().getTime()})?(e.ui.queueMapClasses({mouse:F.DRAG}),a.drag(s)):s.originalEvent.stopPropagation()},i.mousedrag=function(s){i.drag(s,d=>!tt(r,d))},i.touchdrag=function(s){i.drag(s,d=>!rt(n,d))},i.mousemove=function(s){if((s.originalEvent.buttons!==void 0?s.originalEvent.buttons:s.originalEvent.which)===1)return i.mousedrag(s);const g=Fe(s,e);s.featureTarget=g,a.mousemove(s)},i.mousedown=function(s){r={time:new Date().getTime(),point:s.point};const d=Fe(s,e);s.featureTarget=d,a.mousedown(s)},i.mouseup=function(s){const d=Fe(s,e);s.featureTarget=d,tt(r,{point:s.point,time:new Date().getTime()})?a.click(s):a.mouseup(s)},i.mouseout=function(s){a.mouseout(s)},i.touchstart=function(s){if(!e.options.touchEnabled)return;n={time:new Date().getTime(),point:s.point};const d=Se.touch(s,null,e)[0];s.featureTarget=d,a.touchstart(s)},i.touchmove=function(s){if(e.options.touchEnabled)return a.touchmove(s),i.touchdrag(s)},i.touchend=function(s){if(s.originalEvent.preventDefault(),!e.options.touchEnabled)return;const d=Se.touch(s,null,e)[0];s.featureTarget=d,rt(n,{time:new Date().getTime(),point:s.point})?a.tap(s):a.touchend(s)};const l=s=>{const d=Qe(s),g=et(s),y=$t(s);return!(d||g||y)};i.keydown=function(s){(s.srcElement||s.target).classList.contains(Q.CANVAS)&&((Qe(s)||et(s))&&e.options.controls.trash?(s.preventDefault(),a.trash()):l(s)?a.keydown(s):Gt(s)&&e.options.controls.point?c(_.DRAW_POINT):Vt(s)&&e.options.controls.line_string?c(_.DRAW_LINE_STRING):Bt(s)&&e.options.controls.polygon&&c(_.DRAW_POLYGON))},i.keyup=function(s){l(s)&&a.keyup(s)},i.zoomend=function(){e.store.changeZoom()},i.data=function(s){if(s.dataType==="style"){const{setup:d,map:g,options:y,store:b}=e;y.styles.some(T=>g.getLayer(T.id))||(d.addLayers(),b.setDirty(),b.render())}};function c(s,d,g={}){a.stop();const y=t[s];if(y===void 0)throw new Error(`${s} is not valid`);o=s;const b=y(e,d);a=nt(b,e),g.silent||e.map.fire(X.MODE_CHANGE,{mode:s}),e.store.setDirty(),e.store.render()}const f={trash:!1,combineFeatures:!1,uncombineFeatures:!1};function m(s){let d=!1;Object.keys(s).forEach(g=>{if(f[g]===void 0)throw new Error("Invalid action type");f[g]!==s[g]&&(d=!0),f[g]=s[g]}),d&&e.map.fire(X.ACTIONABLE,{actions:f})}return{start(){o=e.options.defaultMode,a=nt(t[o](e),e)},changeMode:c,actionable:m,currentModeName(){return o},currentModeRender(s,d){return a.render(s,d)},fire(s,d){e.map&&e.map.fire(s,d)},addEventListeners(){e.map.on("mousemove",i.mousemove),e.map.on("mousedown",i.mousedown),e.map.on("mouseup",i.mouseup),e.map.on("data",i.data),e.map.on("touchmove",i.touchmove),e.map.on("touchstart",i.touchstart),e.map.on("touchend",i.touchend),e.container.addEventListener("mouseout",i.mouseout),e.options.keybindings&&(e.container.addEventListener("keydown",i.keydown),e.container.addEventListener("keyup",i.keyup))},removeEventListeners(){e.map.off("mousemove",i.mousemove),e.map.off("mousedown",i.mousedown),e.map.off("mouseup",i.mouseup),e.map.off("data",i.data),e.map.off("touchmove",i.touchmove),e.map.off("touchstart",i.touchstart),e.map.off("touchend",i.touchend),e.container.removeEventListener("mouseout",i.mouseout),e.options.keybindings&&(e.container.removeEventListener("keydown",i.keydown),e.container.removeEventListener("keyup",i.keyup))},trash(s){a.trash(s)},combineFeatures(){a.combineFeatures()},uncombineFeatures(){a.uncombineFeatures()},getMode(){return o}}}function Oe(e){return[].concat(e).filter(t=>t!==void 0)}function jr(){const e=this;if(!(e.ctx.map&&e.ctx.map.getSource(ie.HOT)!==void 0))return c();const r=e.ctx.events.currentModeName();e.ctx.ui.queueMapClasses({mode:r});let n=[],i=[];e.isDirty?i=e.getAllIds():(n=e.getChangedIds().filter(f=>e.get(f)!==void 0),i=e.sources.hot.filter(f=>f.properties.id&&n.indexOf(f.properties.id)===-1&&e.get(f.properties.id)!==void 0).map(f=>f.properties.id)),e.sources.hot=[];const o=e.sources.cold.length;e.sources.cold=e.isDirty?[]:e.sources.cold.filter(f=>{const m=f.properties.id||f.properties.parent;return n.indexOf(m)===-1});const a=o!==e.sources.cold.length||i.length>0;n.forEach(f=>l(f,"hot")),i.forEach(f=>l(f,"cold"));function l(f,m){const s=e.get(f).internal(r);e.ctx.events.currentModeRender(s,d=>{d.properties.mode=r,e.sources[m].push(d)})}a&&e.ctx.map.getSource(ie.COLD).setData({type:C.FEATURE_COLLECTION,features:e.sources.cold}),e.ctx.map.getSource(ie.HOT).setData({type:C.FEATURE_COLLECTION,features:e.sources.hot}),c();function c(){e.isDirty=!1,e.clearChangedIds()}}function x(e){this._features={},this._featureIds=new se,this._selectedFeatureIds=new se,this._selectedCoordinates=[],this._changedFeatureIds=new se,this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=e,this.sources={hot:[],cold:[]};let t;this.render=()=>{t||(t=requestAnimationFrame(()=>{t=null,jr.call(this),this._emitSelectionChange&&(this.ctx.events.fire(X.SELECTION_CHANGE,{features:this.getSelected().map(r=>r.toGeoJSON()),points:this.getSelectedCoordinates().map(r=>({type:C.FEATURE,properties:{},geometry:{type:C.POINT,coordinates:r.coordinates}}))}),this._emitSelectionChange=!1),this.ctx.events.fire(X.RENDER,{})}))},this.isDirty=!1}x.prototype.createRenderBatch=function(){const e=this.render;let t=0;return this.render=function(){t++},()=>{this.render=e,t>0&&this.render()}};x.prototype.setDirty=function(){return this.isDirty=!0,this};x.prototype.featureCreated=function(e,t={}){if(this._changedFeatureIds.add(e),(t.silent!=null?t.silent:this.ctx.options.suppressAPIEvents)!==!0){const n=this.get(e);this.ctx.events.fire(X.CREATE,{features:[n.toGeoJSON()]})}return this};x.prototype.featureChanged=function(e,t={}){return this._changedFeatureIds.add(e),(t.silent!=null?t.silent:this.ctx.options.suppressAPIEvents)!==!0&&this.ctx.events.fire(X.UPDATE,{action:t.action?t.action:Ie.CHANGE_COORDINATES,features:[this.get(e).toGeoJSON()]}),this};x.prototype.getChangedIds=function(){return this._changedFeatureIds.values()};x.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this};x.prototype.getAllIds=function(){return this._featureIds.values()};x.prototype.add=function(e,t={}){return this._features[e.id]=e,this._featureIds.add(e.id),this.featureCreated(e.id,{silent:t.silent}),this};x.prototype.delete=function(e,t={}){const r=[];return Oe(e).forEach(n=>{this._featureIds.has(n)&&(this._featureIds.delete(n),this._selectedFeatureIds.delete(n),t.silent||r.indexOf(this._features[n])===-1&&r.push(this._features[n].toGeoJSON()),delete this._features[n],this.isDirty=!0)}),r.length&&this.ctx.events.fire(X.DELETE,{features:r}),Yt(this,t),this};x.prototype.get=function(e){return this._features[e]};x.prototype.getAll=function(){return Object.keys(this._features).map(e=>this._features[e])};x.prototype.select=function(e,t={}){return Oe(e).forEach(r=>{this._selectedFeatureIds.has(r)||(this._selectedFeatureIds.add(r),this._changedFeatureIds.add(r),t.silent||(this._emitSelectionChange=!0))}),this};x.prototype.deselect=function(e,t={}){return Oe(e).forEach(r=>{this._selectedFeatureIds.has(r)&&(this._selectedFeatureIds.delete(r),this._changedFeatureIds.add(r),t.silent||(this._emitSelectionChange=!0))}),Yt(this,t),this};x.prototype.clearSelected=function(e={}){return this.deselect(this._selectedFeatureIds.values(),{silent:e.silent}),this};x.prototype.setSelected=function(e,t={}){return e=Oe(e),this.deselect(this._selectedFeatureIds.values().filter(r=>e.indexOf(r)===-1),{silent:t.silent}),this.select(e.filter(r=>!this._selectedFeatureIds.has(r)),{silent:t.silent}),this};x.prototype.setSelectedCoordinates=function(e){return this._selectedCoordinates=e,this._emitSelectionChange=!0,this};x.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this};x.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()};x.prototype.getSelected=function(){return this.getSelectedIds().map(e=>this.get(e))};x.prototype.getSelectedCoordinates=function(){return this._selectedCoordinates.map(t=>({coordinates:this.get(t.feature_id).getCoordinate(t.coord_path)}))};x.prototype.isSelected=function(e){return this._selectedFeatureIds.has(e)};x.prototype.setFeatureProperty=function(e,t,r,n={}){this.get(e).setProperty(t,r),this.featureChanged(e,{silent:n.silent,action:Ie.CHANGE_PROPERTIES})};function Yt(e,t={}){const r=e._selectedCoordinates.filter(n=>e._selectedFeatureIds.has(n.feature_id));e._selectedCoordinates.length!==r.length&&!t.silent&&(e._emitSelectionChange=!0),e._selectedCoordinates=r}x.prototype.storeMapConfig=function(){kt.forEach(e=>{this.ctx.map[e]&&(this._mapInitialConfig[e]=this.ctx.map[e].isEnabled())})};x.prototype.restoreMapConfig=function(){Object.keys(this._mapInitialConfig).forEach(e=>{this._mapInitialConfig[e]?this.ctx.map[e].enable():this.ctx.map[e].disable()})};x.prototype.getInitialConfigValue=function(e){return this._mapInitialConfig[e]!==void 0?this._mapInitialConfig[e]:!0};const Jr=["mode","feature","mouse"];function qr(e){const t={};let r=null,n={mode:null,feature:null,mouse:null},i={mode:null,feature:null,mouse:null};function o(){a({mode:null,feature:null,mouse:null}),l()}function a(d){i=Object.assign(i,d)}function l(){if(!e.container)return;const d=[],g=[];Jr.forEach(y=>{i[y]!==n[y]&&(d.push(`${y}-${n[y]}`),i[y]!==null&&g.push(`${y}-${i[y]}`))}),d.length>0&&e.container.classList.remove(...d),g.length>0&&e.container.classList.add(...g),n=Object.assign(n,i)}function c(d,g={}){const y=document.createElement("button");return y.className=`${Q.CONTROL_BUTTON} ${g.className}`,y.setAttribute("title",g.title),g.container.appendChild(y),y.addEventListener("click",b=>{if(b.preventDefault(),b.stopPropagation(),b.target===r){f(),g.onDeactivate();return}m(d),g.onActivate()},!0),y}function f(){r&&(r.classList.remove(Q.ACTIVE_BUTTON),r=null)}function m(d){f();const g=t[d];g&&g&&d!=="trash"&&(g.classList.add(Q.ACTIVE_BUTTON),r=g)}function p(){const d=e.options.controls,g=document.createElement("div");return g.className=`${Q.CONTROL_GROUP} ${Q.CONTROL_BASE}`,d&&(d[ee.POINT]&&(t[ee.POINT]=c(ee.POINT,{container:g,className:Q.CONTROL_BUTTON_POINT,title:`Marker tool ${e.options.keybindings?"(1)":""}`,onActivate:()=>e.events.changeMode(_.DRAW_POINT),onDeactivate:()=>e.events.trash()})),d[ee.LINE]&&(t[ee.LINE]=c(ee.LINE,{container:g,className:Q.CONTROL_BUTTON_LINE,title:`LineString tool ${e.options.keybindings?"(2)":""}`,onActivate:()=>e.events.changeMode(_.DRAW_LINE_STRING),onDeactivate:()=>e.events.trash()})),d[ee.POLYGON]&&(t[ee.POLYGON]=c(ee.POLYGON,{container:g,className:Q.CONTROL_BUTTON_POLYGON,title:`Polygon tool ${e.options.keybindings?"(3)":""}`,onActivate:()=>e.events.changeMode(_.DRAW_POLYGON),onDeactivate:()=>e.events.trash()})),d.trash&&(t.trash=c("trash",{container:g,className:Q.CONTROL_BUTTON_TRASH,title:"Delete",onActivate:()=>{e.events.trash()}})),d.combine_features&&(t.combine_features=c("combineFeatures",{container:g,className:Q.CONTROL_BUTTON_COMBINE_FEATURES,title:"Combine",onActivate:()=>{e.events.combineFeatures()}})),d.uncombine_features&&(t.uncombine_features=c("uncombineFeatures",{container:g,className:Q.CONTROL_BUTTON_UNCOMBINE_FEATURES,title:"Uncombine",onActivate:()=>{e.events.uncombineFeatures()}}))),g}function s(){Object.keys(t).forEach(d=>{const g=t[d];g.parentNode&&g.parentNode.removeChild(g),delete t[d]})}return{setActiveButton:m,queueMapClasses:a,updateMapClasses:l,clearMapClasses:o,addButtons:p,removeButtons:s}}function zr(e){let t=null,r=null;const n={onRemove(){return e.map.off("load",n.connect),clearInterval(r),n.removeLayers(),e.store.restoreMapConfig(),e.ui.removeButtons(),e.events.removeEventListeners(),e.ui.clearMapClasses(),e.boxZoomInitial&&e.map.boxZoom.enable(),e.map=null,e.container=null,e.store=null,t&&t.parentNode&&t.parentNode.removeChild(t),t=null,this},connect(){e.map.off("load",n.connect),clearInterval(r),n.addLayers(),e.store.storeMapConfig(),e.events.addEventListeners()},onAdd(i){if(e.map=i,e.events=$r(e),e.ui=qr(e),e.container=i.getContainer(),e.store=new x(e),t=e.ui.addButtons(),e.options.boxSelect){e.boxZoomInitial=i.boxZoom.isEnabled(),i.boxZoom.disable();const o=i.dragPan.isEnabled();i.dragPan.disable(),i.dragPan.enable(),o||i.dragPan.disable()}return i.loaded()?n.connect():(i.on("load",n.connect),r=setInterval(()=>{i.loaded()&&n.connect()},16)),e.events.start(),t},addLayers(){e.map.addSource(ie.COLD,{data:{type:C.FEATURE_COLLECTION,features:[]},type:"geojson"}),e.map.addSource(ie.HOT,{data:{type:C.FEATURE_COLLECTION,features:[]},type:"geojson"}),e.options.styles.forEach(i=>{e.map.addLayer(i)}),e.store.setDirty(!0),e.store.render()},removeLayers(){e.options.styles.forEach(i=>{e.map.getLayer(i.id)&&e.map.removeLayer(i.id)}),e.map.getSource(ie.COLD)&&e.map.removeSource(ie.COLD),e.map.getSource(ie.HOT)&&e.map.removeSource(ie.HOT)}};return e.setup=n,n}const Ye="#3bb2d0",we="#fbb03b",Et="#fff",Xt=[{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"]],paint:{"fill-color":["case",["==",["get","active"],"true"],we,Ye],"fill-opacity":.1}},{id:"gl-draw-lines",type:"line",filter:["any",["==","$type","LineString"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":["case",["==",["get","active"],"true"],we,Ye],"line-dasharray":["case",["==",["get","active"],"true"],[.2,2],[2,0]],"line-width":2}},{id:"gl-draw-point-outer",type:"circle",filter:["all",["==","$type","Point"],["==","meta","feature"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],7,5],"circle-color":Et}},{id:"gl-draw-point-inner",type:"circle",filter:["all",["==","$type","Point"],["==","meta","feature"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],5,3],"circle-color":["case",["==",["get","active"],"true"],we,Ye]}},{id:"gl-draw-vertex-outer",type:"circle",filter:["all",["==","$type","Point"],["==","meta","vertex"],["!=","mode","simple_select"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],7,5],"circle-color":Et}},{id:"gl-draw-vertex-inner",type:"circle",filter:["all",["==","$type","Point"],["==","meta","vertex"],["!=","mode","simple_select"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],5,3],"circle-color":we}},{id:"gl-draw-midpoint",type:"circle",filter:["all",["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":we}}];function ge(e,t){this.x=e,this.y=t}ge.prototype={clone(){return new ge(this.x,this.y)},add(e){return this.clone()._add(e)},sub(e){return this.clone()._sub(e)},multByPoint(e){return this.clone()._multByPoint(e)},divByPoint(e){return this.clone()._divByPoint(e)},mult(e){return this.clone()._mult(e)},div(e){return this.clone()._div(e)},rotate(e){return this.clone()._rotate(e)},rotateAround(e,t){return this.clone()._rotateAround(e,t)},matMult(e){return this.clone()._matMult(e)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(e){return this.x===e.x&&this.y===e.y},dist(e){return Math.sqrt(this.distSqr(e))},distSqr(e){const t=e.x-this.x,r=e.y-this.y;return t*t+r*r},angle(){return Math.atan2(this.y,this.x)},angleTo(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith(e){return this.angleWithSep(e.x,e.y)},angleWithSep(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult(e){const t=e[0]*this.x+e[1]*this.y,r=e[2]*this.x+e[3]*this.y;return this.x=t,this.y=r,this},_add(e){return this.x+=e.x,this.y+=e.y,this},_sub(e){return this.x-=e.x,this.y-=e.y,this},_mult(e){return this.x*=e,this.y*=e,this},_div(e){return this.x/=e,this.y/=e,this},_multByPoint(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint(e){return this.x/=e.x,this.y/=e.y,this},_unit(){return this._div(this.mag()),this},_perp(){const e=this.y;return this.y=this.x,this.x=-e,this},_rotate(e){const t=Math.cos(e),r=Math.sin(e),n=t*this.x-r*this.y,i=r*this.x+t*this.y;return this.x=n,this.y=i,this},_rotateAround(e,t){const r=Math.cos(e),n=Math.sin(e),i=t.x+r*(this.x-t.x)-n*(this.y-t.y),o=t.y+n*(this.x-t.x)+r*(this.y-t.y);return this.x=i,this.y=o,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:ge};ge.convert=function(e){if(e instanceof ge)return e;if(Array.isArray(e))return new ge(+e[0],+e[1]);if(e.x!==void 0&&e.y!==void 0)return new ge(+e.x,+e.y);throw new Error("Expected [x, y] or {x, y} point format")};function ut(e,t){const r=t.getBoundingClientRect();return new ge(e.clientX-r.left-(t.clientLeft||0),e.clientY-r.top-(t.clientTop||0))}function Te(e,t,r,n){return{type:C.FEATURE,properties:{meta:J.VERTEX,parent:e,coord_path:r,active:n?$.ACTIVE:$.INACTIVE},geometry:{type:C.POINT,coordinates:t}}}function Yr(e,t,r={}){const n={type:"Feature"};return(r.id===0||r.id)&&(n.id=r.id),r.bbox&&(n.bbox=r.bbox),n.properties={},n.geometry=e,n}function Xr(e,t,r={}){if(!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");if(e.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!ot(e[0])||!ot(e[1]))throw new Error("coordinates must contain numbers");return Yr({type:"Point",coordinates:e},t,r)}function ot(e){return!isNaN(e)&&e!==null&&!Array.isArray(e)}function Wt(e,t,r){if(e!==null)for(var n,i,o,a,l,c,f,m=0,p=0,s,d=e.type,g=d==="FeatureCollection",y=d==="Feature",b=g?e.features.length:1,u=0;u<b;u++){f=g?e.features[u].geometry:y?e.geometry:e,s=f?f.type==="GeometryCollection":!1,l=s?f.geometries.length:1;for(var T=0;T<l;T++){var w=0,I=0;if(a=s?f.geometries[T]:f,a!==null){c=a.coordinates;var P=a.type;switch(m=0,P){case null:break;case"Point":if(t(c,p,u,w,I)===!1)return!1;p++,w++;break;case"LineString":case"MultiPoint":for(n=0;n<c.length;n++){if(t(c[n],p,u,w,I)===!1)return!1;p++,P==="MultiPoint"&&w++}P==="LineString"&&w++;break;case"Polygon":case"MultiLineString":for(n=0;n<c.length;n++){for(i=0;i<c[n].length-m;i++){if(t(c[n][i],p,u,w,I)===!1)return!1;p++}P==="MultiLineString"&&w++,P==="Polygon"&&I++}P==="Polygon"&&w++;break;case"MultiPolygon":for(n=0;n<c.length;n++){for(I=0,i=0;i<c[n].length;i++){for(o=0;o<c[n][i].length-m;o++){if(t(c[n][i][o],p,u,w,I)===!1)return!1;p++}I++}w++}break;case"GeometryCollection":for(n=0;n<a.geometries.length;n++)if(Wt(a.geometries[n],t)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function Wr(e){if(!e)throw new Error("geojson is required");switch(e.type){case"Feature":return Ht(e);case"FeatureCollection":return Hr(e);case"Point":case"LineString":case"Polygon":case"MultiPoint":case"MultiLineString":case"MultiPolygon":case"GeometryCollection":return dt(e);default:throw new Error("unknown GeoJSON type")}}function Ht(e){const t={type:"Feature"};return Object.keys(e).forEach(r=>{switch(r){case"type":case"properties":case"geometry":return;default:t[r]=e[r]}}),t.properties=Kt(e.properties),e.geometry==null?t.geometry=null:t.geometry=dt(e.geometry),t}function Kt(e){const t={};return e&&Object.keys(e).forEach(r=>{const n=e[r];typeof n=="object"?n===null?t[r]=null:Array.isArray(n)?t[r]=n.map(i=>i):t[r]=Kt(n):t[r]=n}),t}function Hr(e){const t={type:"FeatureCollection"};return Object.keys(e).forEach(r=>{switch(r){case"type":case"features":return;default:t[r]=e[r]}}),t.features=e.features.map(r=>Ht(r)),t}function dt(e){const t={type:e.type};return e.bbox&&(t.bbox=e.bbox),e.type==="GeometryCollection"?(t.geometries=e.geometries.map(r=>dt(r)),t):(t.coordinates=Zt(e.coordinates),t)}function Zt(e){const t=e;return typeof t[0]!="object"?t.slice():t.map(r=>Zt(r))}function Ct(e,t={}){return Qt(e,"mercator",t)}function Kr(e,t={}){return Qt(e,"wgs84",t)}function Qt(e,t,r={}){r=r||{};var n=r.mutate;if(!e)throw new Error("geojson is required");return Array.isArray(e)&&ot(e[0])?e=t==="mercator"?bt(e):St(e):(n!==!0&&(e=Wr(e)),Wt(e,function(i){var o=t==="mercator"?bt(i):St(i);i[0]=o[0],i[1]=o[1]})),e}function bt(e){var t=Math.PI/180,r=6378137,n=20037508342789244e-9,i=Math.abs(e[0])<=180?e[0]:e[0]-Zr(e[0])*360,o=[r*i*t,r*Math.log(Math.tan(Math.PI*.25+.5*e[1]*t))];return o[0]>n&&(o[0]=n),o[0]<-n&&(o[0]=-n),o[1]>n&&(o[1]=n),o[1]<-n&&(o[1]=-n),o}function St(e){var t=180/Math.PI,r=6378137;return[e[0]*t/r,(Math.PI*.5-2*Math.atan(Math.exp(-e[1]/r)))*t]}function Zr(e){return e<0?-1:e>0?1:0}function er(e,t,r){const n=t.geometry.coordinates,i=r.geometry.coordinates;if(n[1]>Ze||n[1]<Ke||i[1]>Ze||i[1]<Ke)return null;const o=Ct(n),a=Ct(i),l=p=>Number(p.toFixed(8)),c=(p,s)=>(p+s)/2,f=Kr([c(o[0],a[0]),c(o[1],a[1])]),m=[l(f[0]),l(f[1])];return{type:C.FEATURE,properties:{meta:J.MIDPOINT,parent:e,lng:m[0],lat:m[1],coord_path:r.properties.coord_path},geometry:{type:C.POINT,coordinates:m}}}function $e(e,t={},r=null){const{type:n,coordinates:i}=e.geometry,o=e.properties&&e.properties.id;let a=[];n===C.POINT?a.push(Te(o,i,r,c(r))):n===C.POLYGON?i.forEach((m,p)=>{l(m,r!==null?`${r}.${p}`:String(p))}):n===C.LINE_STRING?l(i,r):n.indexOf(C.MULTI_PREFIX)===0&&f();function l(m,p){let s="",d=null;m.forEach((g,y)=>{const b=p!=null?`${p}.${y}`:String(y),u=Te(o,g,b,c(b));if(t.midpoints&&d){const w=er(o,d,u);w&&a.push(w)}d=u;const T=JSON.stringify(g);s!==T&&a.push(u),y===0&&(s=T)})}function c(m){return t.selectedPaths?t.selectedPaths.indexOf(m)!==-1:!1}function f(){const m=n.replace(C.MULTI_PREFIX,"");i.forEach((p,s)=>{const d={type:C.FEATURE,properties:e.properties,geometry:{type:m,coordinates:p}};a=a.concat($e(d,t,s))})}return a}const le={enable(e){setTimeout(()=>{!e.map||!e.map.doubleClickZoom||!e._ctx||!e._ctx.store||!e._ctx.store.getInitialConfigValue||e._ctx.store.getInitialConfigValue("doubleClickZoom")&&e.map.doubleClickZoom.enable()},0)},disable(e){setTimeout(()=>{!e.map||!e.map.doubleClickZoom||e.map.doubleClickZoom.disable()},0)}},{LAT_MIN:Ae,LAT_MAX:xe,LAT_RENDERED_MIN:Tt,LAT_RENDERED_MAX:vt,LNG_MIN:_t,LNG_MAX:wt}=Dt;function Qr(e){const t={Point:0,LineString:1,Polygon:2,MultiPoint:1,MultiLineString:2,MultiPolygon:3}[e.geometry.type],r=[e.geometry.coordinates].flat(t),n=r.map(l=>l[0]),i=r.map(l=>l[1]),o=l=>Math.min.apply(null,l),a=l=>Math.max.apply(null,l);return[o(n),o(i),a(n),a(i)]}function ft(e,t){let r=Ae,n=xe,i=Ae,o=xe,a=wt,l=_t;e.forEach(f=>{const m=Qr(f),p=m[1],s=m[3],d=m[0],g=m[2];p>r&&(r=p),s<n&&(n=s),s>i&&(i=s),p<o&&(o=p),d<a&&(a=d),g>l&&(l=g)});const c=t;return r+c.lat>vt&&(c.lat=vt-r),i+c.lat>xe&&(c.lat=xe-i),n+c.lat<Tt&&(c.lat=Tt-n),o+c.lat<Ae&&(c.lat=Ae-o),a+c.lng<=_t&&(c.lng+=Math.ceil(Math.abs(c.lng)/360)*360),l+c.lng>=wt&&(c.lng-=Math.ceil(Math.abs(c.lng)/360)*360),c}function pt(e,t){const r=ft(e.map(n=>n.toGeoJSON()),t);e.forEach(n=>{const i=n.getCoordinates(),o=f=>{const m={lng:f[0]+r.lng,lat:f[1]+r.lat};return[m.lng,m.lat]},a=f=>f.map(m=>o(m)),l=f=>f.map(m=>a(m));let c;n.type===C.POINT?c=o(i):n.type===C.LINE_STRING||n.type===C.MULTI_POINT?c=i.map(o):n.type===C.POLYGON||n.type===C.MULTI_LINE_STRING?c=i.map(a):n.type===C.MULTI_POLYGON&&(c=i.map(l)),n.incomingCoords(c)})}const N={};N.onSetup=function(e){const t={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initialDragPanState:this.map.dragPan.isEnabled(),initiallySelectedFeatureIds:e.featureIds||[]};return this.setSelected(t.initiallySelectedFeatureIds.filter(r=>this.getFeature(r)!==void 0)),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),t};N.fireUpdate=function(){this.fire(X.UPDATE,{action:Ie.MOVE,features:this.getSelected().map(e=>e.toGeoJSON())})};N.fireActionable=function(){const e=this.getSelected(),t=e.filter(o=>this.isInstanceOf("MultiFeature",o));let r=!1;if(e.length>1){r=!0;const o=e[0].type.replace("Multi","");e.forEach(a=>{a.type.replace("Multi","")!==o&&(r=!1)})}const n=t.length>0,i=e.length>0;this.setActionableState({combineFeatures:r,uncombineFeatures:n,trash:i})};N.getUniqueIds=function(e){return e.length?e.map(r=>r.properties.id).filter(r=>r!==void 0).reduce((r,n)=>(r.add(n),r),new se).values():[]};N.stopExtendedInteractions=function(e){e.boxSelectElement&&(e.boxSelectElement.parentNode&&e.boxSelectElement.parentNode.removeChild(e.boxSelectElement),e.boxSelectElement=null),(e.canDragMove||e.canBoxSelect)&&e.initialDragPanState===!0&&this.map.dragPan.enable(),e.boxSelecting=!1,e.canBoxSelect=!1,e.dragMoving=!1,e.canDragMove=!1};N.onStop=function(){le.enable(this)};N.onMouseMove=function(e,t){return at(t)&&e.dragMoving&&this.fireUpdate(),this.stopExtendedInteractions(e),!0};N.onMouseOut=function(e){return e.dragMoving?this.fireUpdate():!0};N.onTap=N.onClick=function(e,t){if(Ue(t))return this.clickAnywhere(e,t);if(De(J.VERTEX)(t))return this.clickOnVertex(e,t);if(at(t))return this.clickOnFeature(e,t)};N.clickAnywhere=function(e){const t=this.getSelectedIds();t.length&&(this.clearSelectedFeatures(),t.forEach(r=>this.doRender(r))),le.enable(this),this.stopExtendedInteractions(e)};N.clickOnVertex=function(e,t){this.changeMode(_.DIRECT_SELECT,{featureId:t.featureTarget.properties.parent,coordPath:t.featureTarget.properties.coord_path,startPos:t.lngLat}),this.updateUIClasses({mouse:F.MOVE})};N.startOnActiveFeature=function(e,t){this.stopExtendedInteractions(e),this.map.dragPan.disable(),this.doRender(t.featureTarget.properties.id),e.canDragMove=!0,e.dragMoveLocation=t.lngLat};N.clickOnFeature=function(e,t){le.disable(this),this.stopExtendedInteractions(e);const r=Re(t),n=this.getSelectedIds(),i=t.featureTarget.properties.id,o=this.isSelected(i);if(!r&&o&&this.getFeature(i).type!==C.POINT)return this.changeMode(_.DIRECT_SELECT,{featureId:i});o&&r?(this.deselect(i),this.updateUIClasses({mouse:F.POINTER}),n.length===1&&le.enable(this)):!o&&r?(this.select(i),this.updateUIClasses({mouse:F.MOVE})):!o&&!r&&(n.forEach(a=>this.doRender(a)),this.setSelected(i),this.updateUIClasses({mouse:F.MOVE})),this.doRender(i)};N.onMouseDown=function(e,t){if(e.initialDragPanState=this.map.dragPan.isEnabled(),Ee(t))return this.startOnActiveFeature(e,t);if(this.drawConfig.boxSelect&&Ut(t))return this.startBoxSelect(e,t)};N.startBoxSelect=function(e,t){this.stopExtendedInteractions(e),this.map.dragPan.disable(),e.boxSelectStartLocation=ut(t.originalEvent,this.map.getContainer()),e.canBoxSelect=!0};N.onTouchStart=function(e,t){if(Ee(t))return this.startOnActiveFeature(e,t)};N.onDrag=function(e,t){if(e.canDragMove)return this.dragMove(e,t);if(this.drawConfig.boxSelect&&e.canBoxSelect)return this.whileBoxSelect(e,t)};N.whileBoxSelect=function(e,t){e.boxSelecting=!0,this.updateUIClasses({mouse:F.ADD}),e.boxSelectElement||(e.boxSelectElement=document.createElement("div"),e.boxSelectElement.classList.add(Q.BOX_SELECT),this.map.getContainer().appendChild(e.boxSelectElement));const r=ut(t.originalEvent,this.map.getContainer()),n=Math.min(e.boxSelectStartLocation.x,r.x),i=Math.max(e.boxSelectStartLocation.x,r.x),o=Math.min(e.boxSelectStartLocation.y,r.y),a=Math.max(e.boxSelectStartLocation.y,r.y),l=`translate(${n}px, ${o}px)`;e.boxSelectElement.style.transform=l,e.boxSelectElement.style.WebkitTransform=l,e.boxSelectElement.style.width=`${i-n}px`,e.boxSelectElement.style.height=`${a-o}px`};N.dragMove=function(e,t){e.dragMoving=!0,t.originalEvent.stopPropagation();const r={lng:t.lngLat.lng-e.dragMoveLocation.lng,lat:t.lngLat.lat-e.dragMoveLocation.lat};pt(this.getSelected(),r),e.dragMoveLocation=t.lngLat};N.onTouchEnd=N.onMouseUp=function(e,t){if(e.dragMoving)this.fireUpdate();else if(e.boxSelecting){const r=[e.boxSelectStartLocation,ut(t.originalEvent,this.map.getContainer())],n=this.featuresAt(null,r,"click"),i=this.getUniqueIds(n).filter(o=>!this.isSelected(o));i.length&&(this.select(i),i.forEach(o=>this.doRender(o)),this.updateUIClasses({mouse:F.MOVE}))}this.stopExtendedInteractions(e)};N.toDisplayFeatures=function(e,t,r){t.properties.active=this.isSelected(t.properties.id)?$.ACTIVE:$.INACTIVE,r(t),this.fireActionable(),!(t.properties.active!==$.ACTIVE||t.geometry.type===C.POINT)&&$e(t).forEach(r)};N.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()};N.onCombineFeatures=function(){const e=this.getSelected();if(e.length===0||e.length<2)return;const t=[],r=[],n=e[0].type.replace("Multi","");for(let i=0;i<e.length;i++){const o=e[i];if(o.type.replace("Multi","")!==n)return;o.type.includes("Multi")?o.getCoordinates().forEach(a=>{t.push(a)}):t.push(o.getCoordinates()),r.push(o.toGeoJSON())}if(r.length>1){const i=this.newFeature({type:C.FEATURE,properties:r[0].properties,geometry:{type:`Multi${n}`,coordinates:t}});this.addFeature(i),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([i.id]),this.fire(X.COMBINE_FEATURES,{createdFeatures:[i.toGeoJSON()],deletedFeatures:r})}this.fireActionable()};N.onUncombineFeatures=function(){const e=this.getSelected();if(e.length===0)return;const t=[],r=[];for(let n=0;n<e.length;n++){const i=e[n];this.isInstanceOf("MultiFeature",i)&&(i.getFeatures().forEach(o=>{this.addFeature(o),o.properties=i.properties,t.push(o.toGeoJSON()),this.select([o.id])}),this.deleteFeature(i.id,{silent:!0}),r.push(i.toGeoJSON()))}t.length>1&&this.fire(X.UNCOMBINE_FEATURES,{createdFeatures:t,deletedFeatures:r}),this.fireActionable()};const tr=De(J.VERTEX),rr=De(J.MIDPOINT),L={};L.fireUpdate=function(){this.fire(X.UPDATE,{action:Ie.CHANGE_COORDINATES,features:this.getSelected().map(e=>e.toGeoJSON())})};L.fireActionable=function(e){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:e.selectedCoordPaths.length>0})};L.startDragging=function(e,t){e.initialDragPanState==null&&(e.initialDragPanState=this.map.dragPan.isEnabled()),this.map.dragPan.disable(),e.canDragMove=!0,e.dragMoveLocation=t.lngLat};L.stopDragging=function(e){e.canDragMove&&e.initialDragPanState===!0&&this.map.dragPan.enable(),e.initialDragPanState=null,e.dragMoving=!1,e.canDragMove=!1,e.dragMoveLocation=null};L.onVertex=function(e,t){this.startDragging(e,t);const r=t.featureTarget.properties,n=e.selectedCoordPaths.indexOf(r.coord_path);!Re(t)&&n===-1?e.selectedCoordPaths=[r.coord_path]:Re(t)&&n===-1&&e.selectedCoordPaths.push(r.coord_path);const i=this.pathsToCoordinates(e.featureId,e.selectedCoordPaths);this.setSelectedCoordinates(i)};L.onMidpoint=function(e,t){this.startDragging(e,t);const r=t.featureTarget.properties;e.feature.addCoordinate(r.coord_path,r.lng,r.lat),this.fireUpdate(),e.selectedCoordPaths=[r.coord_path]};L.pathsToCoordinates=function(e,t){return t.map(r=>({feature_id:e,coord_path:r}))};L.onFeature=function(e,t){e.selectedCoordPaths.length===0?this.startDragging(e,t):this.stopDragging(e)};L.dragFeature=function(e,t,r){pt(this.getSelected(),r),e.dragMoveLocation=t.lngLat};L.dragVertex=function(e,t,r){const n=e.selectedCoordPaths.map(a=>e.feature.getCoordinate(a)),i=n.map(a=>({type:C.FEATURE,properties:{},geometry:{type:C.POINT,coordinates:a}})),o=ft(i,r);for(let a=0;a<n.length;a++){const l=n[a];e.feature.updateCoordinate(e.selectedCoordPaths[a],l[0]+o.lng,l[1]+o.lat)}};L.clickNoTarget=function(){this.changeMode(_.SIMPLE_SELECT)};L.clickInactive=function(){this.changeMode(_.SIMPLE_SELECT)};L.clickActiveFeature=function(e){e.selectedCoordPaths=[],this.clearSelectedCoordinates(),e.feature.changed()};L.onSetup=function(e){const t=e.featureId,r=this.getFeature(t);if(!r)throw new Error("You must provide a featureId to enter direct_select mode");if(r.type===C.POINT)throw new TypeError("direct_select mode doesn't handle point features");const n={featureId:t,feature:r,dragMoveLocation:e.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:e.coordPath?[e.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(t,n.selectedCoordPaths)),this.setSelected(t),le.disable(this),this.setActionableState({trash:!0}),n};L.onStop=function(){le.enable(this),this.clearSelectedCoordinates()};L.toDisplayFeatures=function(e,t,r){e.featureId===t.properties.id?(t.properties.active=$.ACTIVE,r(t),$e(t,{map:this.map,midpoints:!0,selectedPaths:e.selectedCoordPaths}).forEach(r)):(t.properties.active=$.INACTIVE,r(t)),this.fireActionable(e)};L.onTrash=function(e){e.selectedCoordPaths.sort((t,r)=>r.localeCompare(t,"en",{numeric:!0})).forEach(t=>e.feature.removeCoordinate(t)),this.fireUpdate(),e.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(e),e.feature.isValid()===!1&&(this.deleteFeature([e.featureId]),this.changeMode(_.SIMPLE_SELECT,{}))};L.onMouseMove=function(e,t){const r=Ee(t),n=tr(t),i=rr(t),o=e.selectedCoordPaths.length===0;return r&&o?this.updateUIClasses({mouse:F.MOVE}):n&&!o?this.updateUIClasses({mouse:F.MOVE}):this.updateUIClasses({mouse:F.NONE}),(n||r||i)&&e.dragMoving&&this.fireUpdate(),this.stopDragging(e),!0};L.onMouseOut=function(e){return e.dragMoving&&this.fireUpdate(),!0};L.onTouchStart=L.onMouseDown=function(e,t){if(tr(t))return this.onVertex(e,t);if(Ee(t))return this.onFeature(e,t);if(rr(t))return this.onMidpoint(e,t)};L.onDrag=function(e,t){if(e.canDragMove!==!0)return;e.dragMoving=!0,t.originalEvent.stopPropagation();const r={lng:t.lngLat.lng-e.dragMoveLocation.lng,lat:t.lngLat.lat-e.dragMoveLocation.lat};e.selectedCoordPaths.length>0?this.dragVertex(e,t,r):this.dragFeature(e,t,r),e.dragMoveLocation=t.lngLat};L.onClick=function(e,t){if(Ue(t))return this.clickNoTarget(e,t);if(Ee(t))return this.clickActiveFeature(e,t);if(st(t))return this.clickInactive(e,t);this.stopDragging(e)};L.onTap=function(e,t){if(Ue(t))return this.clickNoTarget(e,t);if(Ee(t))return this.clickActiveFeature(e,t);if(st(t))return this.clickInactive(e,t)};L.onTouchEnd=L.onMouseUp=function(e){e.dragMoving&&this.fireUpdate(),this.stopDragging(e)};const de={};de.onSetup=function(){const e=this.newFeature({type:C.FEATURE,properties:{},geometry:{type:C.POINT,coordinates:[]}});return this.addFeature(e),this.clearSelectedFeatures(),this.updateUIClasses({mouse:F.ADD}),this.activateUIButton(ee.POINT),this.setActionableState({trash:!0}),{point:e}};de.stopDrawingAndRemove=function(e){this.deleteFeature([e.point.id],{silent:!0}),this.changeMode(_.SIMPLE_SELECT)};de.onTap=de.onClick=function(e,t){this.updateUIClasses({mouse:F.MOVE}),e.point.updateCoordinate("",t.lngLat.lng,t.lngLat.lat),this.fire(X.CREATE,{features:[e.point.toGeoJSON()]}),this.changeMode(_.SIMPLE_SELECT,{featureIds:[e.point.id]})};de.onStop=function(e){this.activateUIButton(),e.point.getCoordinate().length||this.deleteFeature([e.point.id],{silent:!0})};de.toDisplayFeatures=function(e,t,r){const n=t.properties.id===e.point.id;if(t.properties.active=n?$.ACTIVE:$.INACTIVE,!n)return r(t)};de.onTrash=de.stopDrawingAndRemove;de.onKeyUp=function(e,t){if(Ge(t)||Ve(t))return this.stopDrawingAndRemove(e,t)};function ke(e,t){return e.lngLat?e.lngLat.lng===t[0]&&e.lngLat.lat===t[1]:!1}const ce={};ce.onSetup=function(){const e=this.newFeature({type:C.FEATURE,properties:{},geometry:{type:C.POLYGON,coordinates:[[]]}});return this.addFeature(e),this.clearSelectedFeatures(),le.disable(this),this.updateUIClasses({mouse:F.ADD}),this.activateUIButton(ee.POLYGON),this.setActionableState({trash:!0}),{polygon:e,currentVertexPosition:0}};ce.clickAnywhere=function(e,t){if(e.currentVertexPosition>0&&ke(t,e.polygon.coordinates[0][e.currentVertexPosition-1]))return this.changeMode(_.SIMPLE_SELECT,{featureIds:[e.polygon.id]});this.updateUIClasses({mouse:F.ADD}),e.polygon.updateCoordinate(`0.${e.currentVertexPosition}`,t.lngLat.lng,t.lngLat.lat),e.currentVertexPosition++,e.polygon.updateCoordinate(`0.${e.currentVertexPosition}`,t.lngLat.lng,t.lngLat.lat)};ce.clickOnVertex=function(e){return this.changeMode(_.SIMPLE_SELECT,{featureIds:[e.polygon.id]})};ce.onMouseMove=function(e,t){e.polygon.updateCoordinate(`0.${e.currentVertexPosition}`,t.lngLat.lng,t.lngLat.lat),Me(t)&&this.updateUIClasses({mouse:F.POINTER})};ce.onTap=ce.onClick=function(e,t){return Me(t)?this.clickOnVertex(e,t):this.clickAnywhere(e,t)};ce.onKeyUp=function(e,t){Ge(t)?(this.deleteFeature([e.polygon.id],{silent:!0}),this.changeMode(_.SIMPLE_SELECT)):Ve(t)&&this.changeMode(_.SIMPLE_SELECT,{featureIds:[e.polygon.id]})};ce.onStop=function(e){this.updateUIClasses({mouse:F.NONE}),le.enable(this),this.activateUIButton(),this.getFeature(e.polygon.id)!==void 0&&(e.polygon.removeCoordinate(`0.${e.currentVertexPosition}`),e.polygon.isValid()?this.fire(X.CREATE,{features:[e.polygon.toGeoJSON()]}):(this.deleteFeature([e.polygon.id],{silent:!0}),this.changeMode(_.SIMPLE_SELECT,{},{silent:!0})))};ce.toDisplayFeatures=function(e,t,r){const n=t.properties.id===e.polygon.id;if(t.properties.active=n?$.ACTIVE:$.INACTIVE,!n)return r(t);if(t.geometry.coordinates.length===0)return;const i=t.geometry.coordinates[0].length;if(!(i<3)){if(t.properties.meta=J.FEATURE,r(Te(e.polygon.id,t.geometry.coordinates[0][0],"0.0",!1)),i>3){const o=t.geometry.coordinates[0].length-3;r(Te(e.polygon.id,t.geometry.coordinates[0][o],`0.${o}`,!1))}if(i<=4){const o=[[t.geometry.coordinates[0][0][0],t.geometry.coordinates[0][0][1]],[t.geometry.coordinates[0][1][0],t.geometry.coordinates[0][1][1]]];if(r({type:C.FEATURE,properties:t.properties,geometry:{coordinates:o,type:C.LINE_STRING}}),i===3)return}return r(t)}};ce.onTrash=function(e){this.deleteFeature([e.polygon.id],{silent:!0}),this.changeMode(_.SIMPLE_SELECT)};const ue={};ue.onSetup=function(e){e=e||{};const t=e.featureId;let r,n,i="forward";if(t){if(r=this.getFeature(t),!r)throw new Error("Could not find a feature with the provided featureId");let o=e.from;if(o&&o.type==="Feature"&&o.geometry&&o.geometry.type==="Point"&&(o=o.geometry),o&&o.type==="Point"&&o.coordinates&&o.coordinates.length===2&&(o=o.coordinates),!o||!Array.isArray(o))throw new Error("Please use the `from` property to indicate which point to continue the line from");const a=r.coordinates.length-1;if(r.coordinates[a][0]===o[0]&&r.coordinates[a][1]===o[1])n=a+1,r.addCoordinate(n,...r.coordinates[a]);else if(r.coordinates[0][0]===o[0]&&r.coordinates[0][1]===o[1])i="backwards",n=0,r.addCoordinate(n,...r.coordinates[0]);else throw new Error("`from` should match the point at either the start or the end of the provided LineString")}else r=this.newFeature({type:C.FEATURE,properties:{},geometry:{type:C.LINE_STRING,coordinates:[]}}),n=0,this.addFeature(r);return this.clearSelectedFeatures(),le.disable(this),this.updateUIClasses({mouse:F.ADD}),this.activateUIButton(ee.LINE),this.setActionableState({trash:!0}),{line:r,currentVertexPosition:n,direction:i}};ue.clickAnywhere=function(e,t){if(e.currentVertexPosition>0&&ke(t,e.line.coordinates[e.currentVertexPosition-1])||e.direction==="backwards"&&ke(t,e.line.coordinates[e.currentVertexPosition+1]))return this.changeMode(_.SIMPLE_SELECT,{featureIds:[e.line.id]});this.updateUIClasses({mouse:F.ADD}),e.line.updateCoordinate(e.currentVertexPosition,t.lngLat.lng,t.lngLat.lat),e.direction==="forward"?(e.currentVertexPosition++,e.line.updateCoordinate(e.currentVertexPosition,t.lngLat.lng,t.lngLat.lat)):e.line.addCoordinate(0,t.lngLat.lng,t.lngLat.lat)};ue.clickOnVertex=function(e){return this.changeMode(_.SIMPLE_SELECT,{featureIds:[e.line.id]})};ue.onMouseMove=function(e,t){e.line.updateCoordinate(e.currentVertexPosition,t.lngLat.lng,t.lngLat.lat),Me(t)&&this.updateUIClasses({mouse:F.POINTER})};ue.onTap=ue.onClick=function(e,t){if(Me(t))return this.clickOnVertex(e,t);this.clickAnywhere(e,t)};ue.onKeyUp=function(e,t){Ve(t)?this.changeMode(_.SIMPLE_SELECT,{featureIds:[e.line.id]}):Ge(t)&&(this.deleteFeature([e.line.id],{silent:!0}),this.changeMode(_.SIMPLE_SELECT))};ue.onStop=function(e){le.enable(this),this.activateUIButton(),this.getFeature(e.line.id)!==void 0&&(e.line.removeCoordinate(`${e.currentVertexPosition}`),e.line.isValid()?this.fire(X.CREATE,{features:[e.line.toGeoJSON()]}):(this.deleteFeature([e.line.id],{silent:!0}),this.changeMode(_.SIMPLE_SELECT,{},{silent:!0})))};ue.onTrash=function(e){this.deleteFeature([e.line.id],{silent:!0}),this.changeMode(_.SIMPLE_SELECT)};ue.toDisplayFeatures=function(e,t,r){const n=t.properties.id===e.line.id;if(t.properties.active=n?$.ACTIVE:$.INACTIVE,!n)return r(t);t.geometry.coordinates.length<2||(t.properties.meta=J.FEATURE,r(Te(e.line.id,t.geometry.coordinates[e.direction==="forward"?t.geometry.coordinates.length-2:1],`${e.direction==="forward"?t.geometry.coordinates.length-2:1}`,!1)),r(t))};const nr={simple_select:N,direct_select:L,draw_point:de,draw_polygon:ce,draw_line_string:ue},en={defaultMode:_.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:Xt,modes:nr,controls:{},userProperties:!1,suppressAPIEvents:!0},tn={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},rn={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function It(e,t){return e.map(r=>r.source?r:Object.assign({},r,{id:`${r.id}.${t}`,source:t==="hot"?ie.HOT:ie.COLD}))}function nn(e={}){let t=Object.assign({},e);return e.controls||(t.controls={}),e.displayControlsDefault===!1?t.controls=Object.assign({},rn,e.controls):t.controls=Object.assign({},tn,e.controls),t=Object.assign({},en,t),t.styles=It(t.styles,"cold").concat(It(t.styles,"hot")),t}var Xe,Mt;function on(){return Mt||(Mt=1,Xe=function e(t,r){if(t===r)return!0;if(t&&r&&typeof t=="object"&&typeof r=="object"){if(t.constructor!==r.constructor)return!1;var n,i,o;if(Array.isArray(t)){if(n=t.length,n!=r.length)return!1;for(i=n;i--!==0;)if(!e(t[i],r[i]))return!1;return!0}if(t.constructor===RegExp)return t.source===r.source&&t.flags===r.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===r.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===r.toString();if(o=Object.keys(t),n=o.length,n!==Object.keys(r).length)return!1;for(i=n;i--!==0;)if(!Object.prototype.hasOwnProperty.call(r,o[i]))return!1;for(i=n;i--!==0;){var a=o[i];if(!e(t[a],r[a]))return!1}return!0}return t!==t&&r!==r}),Xe}var sn=on();const Ot=it(sn);var We,Nt;function an(){if(Nt)return We;Nt=1,We=t;var e={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"};function t(r){if(!r||!r.type)return null;var n=e[r.type];if(!n)return null;if(n==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:r}]};if(n==="feature")return{type:"FeatureCollection",features:[r]};if(n==="featurecollection")return r}return We}var ln=an();const cn=it(ln);function or(e,t){return e.length!==t.length?!1:JSON.stringify(e.map(r=>r).sort())===JSON.stringify(t.map(r=>r).sort())}const un={Polygon:oe,LineString:fe,Point:me,MultiPolygon:Y,MultiLineString:Y,MultiPoint:Y};function dn(e,t){t.modes=_;const r=e.options.suppressAPIEvents!==void 0?!!e.options.suppressAPIEvents:!0;return t.getFeatureIdsAt=function(n){return Se.click({point:n},null,e).map(o=>o.properties.id)},t.getSelectedIds=function(){return e.store.getSelectedIds()},t.getSelected=function(){return{type:C.FEATURE_COLLECTION,features:e.store.getSelectedIds().map(n=>e.store.get(n)).map(n=>n.toGeoJSON())}},t.getSelectedPoints=function(){return{type:C.FEATURE_COLLECTION,features:e.store.getSelectedCoordinates().map(n=>({type:C.FEATURE,properties:{},geometry:{type:C.POINT,coordinates:n.coordinates}}))}},t.set=function(n){if(n.type===void 0||n.type!==C.FEATURE_COLLECTION||!Array.isArray(n.features))throw new Error("Invalid FeatureCollection");const i=e.store.createRenderBatch();let o=e.store.getAllIds().slice();const a=t.add(n),l=new se(a);return o=o.filter(c=>!l.has(c)),o.length&&t.delete(o),i(),a},t.add=function(n){const o=JSON.parse(JSON.stringify(cn(n))).features.map(a=>{if(a.id=a.id||ct(),a.geometry===null)throw new Error("Invalid geometry: null");if(e.store.get(a.id)===void 0||e.store.get(a.id).type!==a.geometry.type){const l=un[a.geometry.type];if(l===void 0)throw new Error(`Invalid geometry type: ${a.geometry.type}.`);const c=new l(e,a);e.store.add(c,{silent:r})}else{const l=e.store.get(a.id),c=l.properties;l.properties=a.properties,Ot(c,a.properties)||e.store.featureChanged(l.id,{silent:r}),Ot(l.getCoordinates(),a.geometry.coordinates)||l.incomingCoords(a.geometry.coordinates)}return a.id});return e.store.render(),o},t.get=function(n){const i=e.store.get(n);if(i)return i.toGeoJSON()},t.getAll=function(){return{type:C.FEATURE_COLLECTION,features:e.store.getAll().map(n=>n.toGeoJSON())}},t.delete=function(n){return e.store.delete(n,{silent:r}),t.getMode()===_.DIRECT_SELECT&&!e.store.getSelectedIds().length?e.events.changeMode(_.SIMPLE_SELECT,void 0,{silent:r}):e.store.render(),t},t.deleteAll=function(){return e.store.delete(e.store.getAllIds(),{silent:r}),t.getMode()===_.DIRECT_SELECT?e.events.changeMode(_.SIMPLE_SELECT,void 0,{silent:r}):e.store.render(),t},t.changeMode=function(n,i={}){return n===_.SIMPLE_SELECT&&t.getMode()===_.SIMPLE_SELECT?(or(i.featureIds||[],e.store.getSelectedIds())||(e.store.setSelected(i.featureIds,{silent:r}),e.store.render()),t):(n===_.DIRECT_SELECT&&t.getMode()===_.DIRECT_SELECT&&i.featureId===e.store.getSelectedIds()[0]||e.events.changeMode(n,i,{silent:r}),t)},t.getMode=function(){return e.events.getMode()},t.trash=function(){return e.events.trash({silent:r}),t},t.combineFeatures=function(){return e.events.combineFeatures({silent:r}),t},t.uncombineFeatures=function(){return e.events.uncombineFeatures({silent:r}),t},t.setFeatureProperty=function(n,i,o){return e.store.setFeatureProperty(n,i,o,{silent:r}),t},t}const fn=Object.freeze(Object.defineProperty({__proto__:null,CommonSelectors:vr,ModeHandler:nt,StringSet:se,constrainFeatureMovement:ft,createMidPoint:er,createSupplementaryPoints:$e,createVertex:Te,doubleClickZoom:le,euclideanDistance:lt,featuresAt:Se,getFeatureAtAndSetCursors:Fe,isClick:tt,isEventAtCoordinates:ke,isTap:rt,mapEventToBoundingBox:Jt,moveFeatures:pt,sortFeatures:jt,stringSetsAreEqual:or,theme:Xt,toDenseArray:Oe},Symbol.toStringTag,{value:"Module"})),pn=function(e,t){e=nn(e);const r={options:e};t=dn(r,t),r.api=t;const n=zr(r);return t.onAdd=n.onAdd,t.onRemove=n.onRemove,t.types=ee,t.options=e,t};function je(e){pn(e,this)}je.modes=nr;je.constants=Dt;je.lib=fn;const he=11102230246251565e-32,j=134217729,hn=(3+8*he)*he;function He(e,t,r,n,i){let o,a,l,c,f=t[0],m=n[0],p=0,s=0;m>f==m>-f?(o=f,f=t[++p]):(o=m,m=n[++s]);let d=0;if(p<e&&s<r)for(m>f==m>-f?(a=f+o,l=o-(a-f),f=t[++p]):(a=m+o,l=o-(a-m),m=n[++s]),o=a,l!==0&&(i[d++]=l);p<e&&s<r;)m>f==m>-f?(a=o+f,c=a-o,l=o-(a-c)+(f-c),f=t[++p]):(a=o+m,c=a-o,l=o-(a-c)+(m-c),m=n[++s]),o=a,l!==0&&(i[d++]=l);for(;p<e;)a=o+f,c=a-o,l=o-(a-c)+(f-c),f=t[++p],o=a,l!==0&&(i[d++]=l);for(;s<r;)a=o+m,c=a-o,l=o-(a-c)+(m-c),m=n[++s],o=a,l!==0&&(i[d++]=l);return(o!==0||d===0)&&(i[d++]=o),d}function gn(e,t){let r=t[0];for(let n=1;n<e;n++)r+=t[n];return r}function Ne(e){return new Float64Array(e)}const mn=(3+16*he)*he,yn=(2+12*he)*he,En=(9+64*he)*he*he,be=Ne(4),Lt=Ne(8),Pt=Ne(12),At=Ne(16),z=Ne(4);function Cn(e,t,r,n,i,o,a){let l,c,f,m,p,s,d,g,y,b,u,T,w,I,P,G,k,V;const H=e-i,te=r-i,K=t-o,q=n-o;I=H*q,s=j*H,d=s-(s-H),g=H-d,s=j*q,y=s-(s-q),b=q-y,P=g*b-(I-d*y-g*y-d*b),G=K*te,s=j*K,d=s-(s-K),g=K-d,s=j*te,y=s-(s-te),b=te-y,k=g*b-(G-d*y-g*y-d*b),u=P-k,p=P-u,be[0]=P-(u+p)+(p-k),T=I+u,p=T-I,w=I-(T-p)+(u-p),u=w-G,p=w-u,be[1]=w-(u+p)+(p-G),V=T+u,p=V-T,be[2]=T-(V-p)+(u-p),be[3]=V;let re=gn(4,be),ye=yn*a;if(re>=ye||-re>=ye||(p=e-H,l=e-(H+p)+(p-i),p=r-te,f=r-(te+p)+(p-i),p=t-K,c=t-(K+p)+(p-o),p=n-q,m=n-(q+p)+(p-o),l===0&&c===0&&f===0&&m===0)||(ye=En*a+hn*Math.abs(re),re+=H*m+q*l-(K*f+te*c),re>=ye||-re>=ye))return re;I=l*q,s=j*l,d=s-(s-l),g=l-d,s=j*q,y=s-(s-q),b=q-y,P=g*b-(I-d*y-g*y-d*b),G=c*te,s=j*c,d=s-(s-c),g=c-d,s=j*te,y=s-(s-te),b=te-y,k=g*b-(G-d*y-g*y-d*b),u=P-k,p=P-u,z[0]=P-(u+p)+(p-k),T=I+u,p=T-I,w=I-(T-p)+(u-p),u=w-G,p=w-u,z[1]=w-(u+p)+(p-G),V=T+u,p=V-T,z[2]=T-(V-p)+(u-p),z[3]=V;const Le=He(4,be,4,z,Lt);I=H*m,s=j*H,d=s-(s-H),g=H-d,s=j*m,y=s-(s-m),b=m-y,P=g*b-(I-d*y-g*y-d*b),G=K*f,s=j*K,d=s-(s-K),g=K-d,s=j*f,y=s-(s-f),b=f-y,k=g*b-(G-d*y-g*y-d*b),u=P-k,p=P-u,z[0]=P-(u+p)+(p-k),T=I+u,p=T-I,w=I-(T-p)+(u-p),u=w-G,p=w-u,z[1]=w-(u+p)+(p-G),V=T+u,p=V-T,z[2]=T-(V-p)+(u-p),z[3]=V;const Je=He(Le,Lt,4,z,Pt);I=l*m,s=j*l,d=s-(s-l),g=l-d,s=j*m,y=s-(s-m),b=m-y,P=g*b-(I-d*y-g*y-d*b),G=c*f,s=j*c,d=s-(s-c),g=c-d,s=j*f,y=s-(s-f),b=f-y,k=g*b-(G-d*y-g*y-d*b),u=P-k,p=P-u,z[0]=P-(u+p)+(p-k),T=I+u,p=T-I,w=I-(T-p)+(u-p),u=w-G,p=w-u,z[1]=w-(u+p)+(p-G),V=T+u,p=V-T,z[2]=T-(V-p)+(u-p),z[3]=V;const qe=He(Je,Pt,4,z,At);return At[qe-1]}function bn(e,t,r,n,i,o){const a=(t-o)*(r-i),l=(e-i)*(n-o),c=a-l,f=Math.abs(a+l);return Math.abs(c)>=mn*f?c:-Cn(e,t,r,n,i,o,f)}function Sn(e,t){var r,n,i=0,o,a,l,c,f,m,p,s=e[0],d=e[1],g=t.length;for(r=0;r<g;r++){n=0;var y=t[r],b=y.length-1;if(m=y[0],m[0]!==y[b][0]&&m[1]!==y[b][1])throw new Error("First and last coordinates in a ring must be the same");for(a=m[0]-s,l=m[1]-d,n;n<b;n++){if(p=y[n+1],c=p[0]-s,f=p[1]-d,l===0&&f===0){if(c<=0&&a>=0||a<=0&&c>=0)return 0}else if(f>=0&&l<=0||f<=0&&l>=0){if(o=bn(a,c,l,f,0,0),o===0)return 0;(o>0&&f>0&&l<=0||o<0&&f<=0&&l>0)&&i++}m=p,l=f,a=c}}return i%2!==0}function Tn(e){if(!e)throw new Error("coord is required");if(!Array.isArray(e)){if(e.type==="Feature"&&e.geometry!==null&&e.geometry.type==="Point")return[...e.geometry.coordinates];if(e.type==="Point")return[...e.coordinates]}if(Array.isArray(e)&&e.length>=2&&!Array.isArray(e[0])&&!Array.isArray(e[1]))return[...e];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function vn(e){return e.type==="Feature"?e.geometry:e}function _n(e,t,r={}){if(!e)throw new Error("point is required");if(!t)throw new Error("polygon is required");const n=Tn(e),i=vn(t),o=i.type,a=t.bbox;let l=i.coordinates;if(a&&wn(n,a)===!1)return!1;o==="Polygon"&&(l=[l]);let c=!1;for(var f=0;f<l.length;++f){const m=Sn(n,l[f]);if(m===0)return!r.ignoreBoundary;m&&(c=!0)}return c}function wn(e,t){return t[0]<=e[0]&&t[1]<=e[1]&&t[2]>=e[0]&&t[3]>=e[1]}var In=_n;const Mn="pk.eyJ1IjoiYWJpZXNwYW5hIiwiYSI6ImNsb3N4NzllYzAyOWYybWw5ZzNpNXlqaHkifQ.UxlTvUuSq9L5jt0jRtRR-A",On="mapbox://styles/mapbox/streets-v12",Nn={search:"",type:[],priceMin:"",priceMax:"",bedrooms:[],sizeMin:"",sizeMax:"",sort:"recommended",location:[],rentType:"long",market:"new-building",amenities:[],showMarketSelector:!0},Ln=[{id:"gl-draw-line",type:"line",filter:["all",["==","$type","LineString"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#D20C0C","line-width":2}},{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"],["!=","mode","static"]],paint:{"fill-color":"#D20C0C","fill-outline-color":"#D20C0C","fill-opacity":.1}},{id:"gl-draw-polygon-midpoint",type:"circle",filter:["all",["==","$type","Point"],["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":"#fbb03b"}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","$type","Polygon"],["!=","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#D20C0C","line-width":2}},{id:"gl-draw-polygon-and-line-vertex-halo-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":5,"circle-color":"#FFF"}},{id:"gl-draw-polygon-and-line-vertex-active",type:"circle",filter:["all",["==","meta","vertex"],["==","$type","Point"],["!=","mode","static"]],paint:{"circle-radius":3,"circle-color":"#D20C0C"}},{id:"gl-draw-polygon-fill-static",type:"fill",filter:["all",["==","$type","Polygon"],["==","mode","static"]],paint:{"fill-color":"#404040","fill-outline-color":"#404040","fill-opacity":.1}},{id:"gl-draw-polygon-stroke-static",type:"line",filter:["all",["==","$type","Polygon"],["==","mode","static"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":"#404040","line-width":2}}],Pn=({property:e})=>{const{isFavorite:t,toggleFavorite:r}=Ft(),n=t(e.id),i=e.images&&e.images.length>0?e.images[0]:e.image||"https://via.placeholder.com/100x70?text=No+Image",{t:o}=xt(),a=new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",maximumFractionDigits:0}),l=e.price?a.format(e.price):o("property.callForPrice"),c=`/${e.market==="rent"?"rent":e.market==="secondary"?"resale":"new-building"}/${e.id}`;return S.jsxs("a",{href:c,target:"_blank",rel:"noopener noreferrer",className:"side-property-card",children:[S.jsxs("div",{className:"side-card-image-wrapper",style:{position:"relative"},children:[S.jsx("img",{src:i,alt:e.title,className:"side-card-image"}),S.jsx("button",{onClick:f=>{f.preventDefault(),f.stopPropagation(),r(e.id)},style:{position:"absolute",top:"4px",right:"4px",background:"rgba(255,255,255,0.8)",border:"none",borderRadius:"50%",width:"24px",height:"24px",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",padding:0,zIndex:5},children:S.jsx(Rt,{size:14,fill:n?"red":"none",color:n?"red":"#333"})})]}),S.jsxs("div",{className:"side-card-content",children:[S.jsx("div",{className:"side-card-title",children:e.title||e.name||"Untitled Property"}),S.jsx("div",{className:"side-card-location",children:e.location?.name||e.address||"Unknown Location"}),S.jsx("div",{className:"side-card-price",children:l})]})]})};function Bn(){const{t:e}=xt(),[t,r]=R.useState([]),[n,i]=R.useState(!0),[o,a]=R.useState(null),[l,c]=R.useState(null),{isFavorite:f,toggleFavorite:m}=Ft(),[p,s]=R.useState(null),[d,g]=R.useState(!1),y=R.useRef(null),b=R.useRef(null),{filters:u,setFilters:T,clearFilters:w}=gr("buy",Nn),[I,P]=R.useState(30);R.useEffect(()=>{if(u.polygon&&typeof u.polygon=="string")try{const h=JSON.parse(u.polygon);JSON.stringify(o)!==u.polygon&&(a(h),y.current&&(y.current.deleteAll(),y.current.add(h)))}catch(h){console.error("Invalid polygon in URL",h)}else!u.polygon&&o&&(a(null),y.current&&y.current.deleteAll());!u.polygon&&y.current},[u.polygon]),R.useEffect(()=>{s(null)},[u]),R.useEffect(()=>{P(30)},[u,o,t]),R.useEffect(()=>{i(!0);const{location:h=[],bedrooms:E=[],type:M=[],amenities:B=[],market:Z,...ae}=u;let D=Z;Z==="new-building"?D="off-plan":Z==="secondary"&&(D="resale");const U={...ae,market:D,subtype:M.length?M.join(","):void 0,amenities:B.length?B.join(","):void 0,town:h.length?h:void 0,beds:E.length?E.map(A=>A==="studio"?0:A):void 0,beds_exact:E.length?"true":void 0};hr(U).then(A=>{const ne=(Array.isArray(A)?A:A.data||[]).map(O=>{const pe=O.lat||O.latitude||O.location?.coordinates?.[1]||0,ve=O.lng||O.longitude||O.location?.coordinates?.[0]||0;return{...O,latitude:Number(pe),longitude:Number(ve),market:O.market==="off-plan"?"new-building":O.market==="resale"?"secondary":O.market}});r(ne)}).catch(A=>console.error(A)).finally(()=>i(!1))},[u]);const G=(h,E,M)=>!(E&&h<E||M&&h>M),k=R.useMemo(()=>t.filter(h=>{if(o){const E=h.latitude,M=h.longitude;if(!E||!M)return!1;try{const B=Xr([M,E]);if(!In(B,o))return!1}catch{return!1}}if(u.market&&h.market&&h.market!==u.market||u.market==="rent"&&u.rentType&&h.rentType&&h.rentType!==u.rentType)return!1;if(u.search){const E=u.search.toLowerCase();if(!(h.title||h.development_name||h.name||"").toLowerCase().includes(E))return!1}if(u.type?.length>0){const E=(h.property_type||h.type||"").toLowerCase();if(!u.type.some(M=>E.includes(M.toLowerCase())))return!1}if(h.price&&!G(h.price,u.priceMin,u.priceMax))return!1;if(u.bedrooms?.length>0){const E=h.beds||h.bedrooms;if(!E)return!1;const M=String(E);if(!(u.bedrooms.includes("4+")&&E>=4)){if(!u.bedrooms.includes(M))return!1}}if(u.location?.length>0){const E=h.town||h.location?.name||h.address||"";if(!u.location.some(M=>E.toLowerCase().includes(M.toLowerCase())||M.toLowerCase().includes(E.toLowerCase())))return!1}if(u.amenities?.length>0){const E=h.amenities||[];if(!u.amenities.every(B=>E.includes(B)))return!1}return!0}),[t,u,o]),V=R.useMemo(()=>({type:"FeatureCollection",features:k.map(h=>({type:"Feature",properties:{...h,marketType:h.market==="new-building"||h.market==="off-plan"?"new-building":"other"},geometry:{type:"Point",coordinates:[h.longitude,h.latitude]}}))}),[k]),H=p||k.slice(0,I),te=!p&&k.length>I,K=!!p,q=R.useRef(u);R.useEffect(()=>{q.current=u},[u]);const re=R.useCallback(h=>{const E=h.features;if(E.length>0){a(E[0]);const M=q.current;T({...M,polygon:JSON.stringify(E[0])})}},[T]),ye=h=>{const E=D=>{const U=D.features[0];if(!U)return;D.preventDefault();const A=U.properties.cluster_id,Ce=U.properties.point_count,ne=h.getSource("properties");A&&ne&&(Ce>100?ne.getClusterExpansionZoom(A,(O,pe)=>{O||h.easeTo({center:U.geometry.coordinates,zoom:pe})}):ne.getClusterLeaves(A,100,0,(O,pe)=>{O||s(pe.map(ve=>ve.properties))}))},M=D=>{const U=D.features[0];if(!U)return;D.preventDefault();let A={...U.properties};try{["images","location","coordinates"].forEach(O=>{typeof A[O]=="string"&&(A[O]=JSON.parse(A[O]))})}catch{}c(A),s(null);const ne=window.innerWidth<768?150:100;h.easeTo({center:U.geometry.coordinates,offset:[0,ne],zoom:15,speed:1.2,curve:1})},B=D=>{D.defaultPrevented||(s(null),c(null))},Z=()=>h.getCanvas().style.cursor="pointer",ae=()=>h.getCanvas().style.cursor="";h.on("click","clusters",E),h.on("click","cluster-count",E),h.on("click","unclustered-point",M),h.on("click",B),h.on("mouseenter","clusters",Z),h.on("mouseleave","clusters",ae),h.on("mouseenter","unclustered-point",Z),h.on("mouseleave","unclustered-point",ae)},Le=R.useCallback(()=>{a(null);const h=q.current;T({...h,polygon:null})},[T]),Je=R.useCallback(h=>{const E=h.target,M=new je({displayControlsDefault:!1,controls:{polygon:!0,trash:!0},styles:Ln});if(E.addControl(M,"top-left"),y.current=M,E.on("draw.create",re),E.on("draw.update",re),E.on("draw.delete",Le),E.on("draw.modechange",B=>g(B.mode==="draw_polygon")),ye(E),o)try{M.add(o)}catch(B){console.error("Error adding initial polygon",B)}},[re,Le,o]),qe=u.market==="rent"?"rent":"buy";R.useEffect(()=>{if(!b.current)return;const h=b.current.getMap();if(!h)return;const E=D=>{const U=D.features[0];if(!U)return;D.preventDefault();const A=U.properties.cluster_id,Ce=U.properties.point_count,ne=h.getSource("properties");A&&ne&&(Ce>100?ne.getClusterExpansionZoom(A,(O,pe)=>{O||h.easeTo({center:U.geometry.coordinates,zoom:pe})}):ne.getClusterLeaves(A,100,0,(O,pe)=>{if(O)return;const ve=pe.map(cr=>cr.properties);s(ve)}))},M=D=>{const U=D.features[0];if(!U)return;D.preventDefault();let A={...U.properties};try{["images","location","coordinates"].forEach(O=>{typeof A[O]=="string"&&(A[O]=JSON.parse(A[O]))})}catch(O){console.error("Error parsing property data",O)}c(A),s(null);const ne=window.innerWidth<768?150:100;h.easeTo({center:U.geometry.coordinates,offset:[0,ne],zoom:15,speed:1.2,curve:1})},B=D=>{D.defaultPrevented||(s(null),c(null))},Z=()=>h.getCanvas().style.cursor="pointer",ae=()=>h.getCanvas().style.cursor="";return h.on("click","clusters",E),h.on("click","cluster-count",E),h.on("click","unclustered-point",M),h.on("click",B),h.on("mouseenter","clusters",Z),h.on("mouseleave","clusters",ae),h.on("mouseenter","unclustered-point",Z),h.on("mouseleave","unclustered-point",ae),()=>{h&&(h.off("click","clusters",E),h.off("click","cluster-count",E),h.off("click","unclustered-point",M),h.off("click",B),h.off("mouseenter","clusters",Z),h.off("mouseleave","clusters",ae),h.off("mouseenter","unclustered-point",Z),h.off("mouseleave","unclustered-point",ae))}},[]);const ir=()=>{if(y.current)if(o)y.current.deleteAll(),a(null),T({...u,polygon:null});else{s(null),c(null);try{y.current.changeMode("draw_polygon")}catch{}}},sr=()=>{let h=[];p?h=p:o&&(h=k);const E=new URLSearchParams;if(h.length>0){const Z=h.map(ae=>ae.id).join(",");Z.length<2e3?E.set("ids",Z):(o&&E.set("polygon",JSON.stringify(o)),u.search&&E.set("search",u.search),u.type?.length&&E.set("type",u.type.join(",")),u.priceMin&&E.set("priceMin",u.priceMin),u.priceMax&&E.set("priceMax",u.priceMax),u.bedrooms?.length&&E.set("bedrooms",u.bedrooms.join(",")),u.amenities?.length&&E.set("amenities",u.amenities.join(",")),u.location?.length&&E.set("location",u.location.join(",")))}else u.search&&E.set("search",u.search),u.type?.length&&E.set("type",u.type.join(",")),u.priceMin&&E.set("priceMin",u.priceMin),u.priceMax&&E.set("priceMax",u.priceMax),u.bedrooms?.length&&E.set("bedrooms",u.bedrooms.join(",")),u.sort&&E.set("sort",u.sort),u.location?.length&&E.set("location",u.location.join(",")),u.rentType&&E.set("rentType",u.rentType),u.amenities?.length&&E.set("amenities",u.amenities.join(","));const B=`/${u.market==="rent"?"rent":u.market==="secondary"?"resale":"new-building"}?${E.toString()}`;window.open(B,"_blank")},ar=R.useCallback(()=>{b.current&&(b.current.getCanvas().style.cursor="pointer")},[]),lr=R.useCallback(()=>{b.current&&(b.current.getCanvas().style.cursor="")},[]);return S.jsxs("div",{style:{height:"100vh",width:"100%",position:"relative"},children:[S.jsx("style",{children:`
                .mapboxgl-ctrl-logo, .mapboxgl-ctrl-bottom-right, .mapboxgl-ctrl-attrib { display: none !important; }
                .map-filters-wrapper .filters-container-flex { flex-wrap: nowrap !important; gap: 0.4rem !important; justify-content: space-between; }
                .map-filters-wrapper .property-filters-container { padding: 0; margin: 0; background: transparent; border-bottom: none !important; }
                .map-filters-wrapper .filters-bottom-row { display: none !important; }
                .map-filters-wrapper .search-input-wrapper { min-width: 120px; flex: 1; }
                .map-filters-wrapper .rent-type-tabs { margin-right: 0.4rem !important; flex-shrink: 0; transform: scale(0.95); transform-origin: left center; }
                .map-filters-wrapper .filter-dropdown-wrapper { min-width: 100px !important; flex: 1 !important; }
                .map-filters-wrapper .filter-dropdown-trigger { padding: 0.5rem 0.7rem !important; gap: 0.4rem !important; }
                .map-filters-wrapper .trigger-label { font-size: 0.75rem !important; }
                .map-filters-wrapper .clear-filters-icon-btn { width: 36px !important; height: 36px !important; }
                
                .draw-area-btn {
                    position: absolute; 
                    bottom: calc(30px + env(safe-area-inset-bottom)); 
                    left: 50%; transform: translateX(-50%); z-index: 100;
                    background: #313131; color: white; border: none; padding: 0.8rem 2rem; border-radius: 50px;
                    font-size: 14px; font-weight: 500; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.2s ease;
                }
                .draw-area-btn:hover { background: #1a1a1a; transform: translateX(-50%) translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
                
                @media (max-width: 1100px) {
                    .map-filters-wrapper {
                        top: 80px !important;
                        width: 95% !important;
                        padding: 0.8rem !important;
                    }
                    /* On mobile map, hide Rent Tabs (User uses Filter Modal) */
                    .map-filters-wrapper .rent-type-tabs {
                        display: none !important;
                    }
                    /* Ensure Mobile Filter Button is visible */
                    .mobile-filter-btn {
                        display: flex !important;
                    }

                    /* Lift Draw Button higher on mobile for browser toolbars */
                    .draw-area-btn {
                        bottom: calc(100px + env(safe-area-inset-bottom));
                        width: 90%;
                        max-width: 300px;
                        text-align: center;
                        z-index: 110;
                    }
                    .side-panel {
                        top: 220px;
                        left: 10px;
                        right: 10px;
                        width: auto;
                        max-height: 40vh;
                        padding: 1rem;
                    }
                }

                .side-panel {
                    position: absolute; top: 190px; left: 20px; bottom: 20px; width: 380px; background: white; z-index: 30;
                    padding: 1.5rem; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border-radius: 16px;
                    transform: translateX(-120%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column;
                }
                .side-panel.open { transform: translateX(0); }
                .side-panel-header { margin-bottom: 1rem; padding-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: baseline; border-bottom: 1px solid #f0f0f0; }
                .side-panel-title { font-size: 18px; font-weight: 700; color: #1a1a1a; font-family: 'Inter', sans-serif; }
                .side-property-card {
                    display: flex; align-items: center; padding: 0.8rem; background: white; border-radius: 8px; margin-bottom: 0.4rem;
                    transition: all 0.2s ease; border: 1px solid transparent; cursor: pointer; text-decoration: none; color: inherit;
                }
                .side-property-card:hover { background: #f9f9f9; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-color: #eee; transform: translateY(-1px); }
                .side-card-image-wrapper { width: 100px; height: 70px; border-radius: 6px; overflow: hidden; flex-shrink: 0; background-color: #eee; }
                .side-card-image { width: 100%; height: 100%; object-fit: cover; }
                .side-card-content { margin-left: 1rem; flex: 1; min-width: 0; }
                .side-card-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #1a1a1a; }
                .side-card-location { font-size: 12px; color: #666; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
                .side-card-price { font-size: 14px; font-weight: 700; color: #1a1a1a; }
                .side-panel::-webkit-scrollbar { width: 6px; }
                .side-panel::-webkit-scrollbar-thumb { background-color: #ddd; border-radius: 3px; }
                /* Popup Overrides */
                .mapboxgl-popup-content { padding: 0 !important; border-radius: 12px !important; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.2) !important; }
                .mapboxgl-popup-tip { display: none !important; }
                .mapboxgl-popup-close-button { display: none !important; }
                .popup-link-btn:hover { transform: scale(1.1); }
            `}),S.jsxs("div",{className:`side-panel ${o||p?"open":""}`,children:[S.jsxs("div",{className:"side-panel-header",children:[S.jsxs("div",{children:[S.jsx("span",{className:"side-panel-title",children:e(K?"map.clusterTitle":"map.areaTitle")}),S.jsx("div",{style:{fontSize:"13px",color:"#666"},children:e("filters.resultsFound").replace("{count}",K?H.length:k.length)})]}),S.jsxs("button",{onClick:sr,style:{background:"transparent",border:"1px solid #ddd",borderRadius:"6px",padding:"6px 10px",fontSize:"12px",fontWeight:500,cursor:"pointer",display:"flex",alignItems:"center",gap:"4px",color:"#333"},children:[e("map.fullList")," ",S.jsx(ht,{size:12})]})]}),S.jsx("div",{style:{flex:1,overflowY:"auto"},children:k.length===0?S.jsx("div",{style:{padding:"2rem",textAlign:"center",color:"#999",fontSize:"14px"},children:e("map.noProperties")}):S.jsxs(S.Fragment,{children:[H.map(h=>S.jsx(Pn,{property:h},h.id)),te&&S.jsx("button",{onClick:()=>P(h=>h+30),style:{width:"100%",padding:"0.8rem",background:"#f5f5f5",border:"none",borderRadius:"8px",color:"#333",cursor:"pointer",fontWeight:600,marginTop:"0.5rem",fontSize:"14px"},children:e("map.loadMore").replace("{count}",k.length-I)})]})})]}),S.jsx("div",{className:"map-filters-wrapper",style:{position:"absolute",top:"100px",left:"50%",transform:"translateX(-50%)",width:"98%",maxWidth:"1800px",zIndex:10,background:"white",padding:"1.2rem 1.5rem",borderRadius:"16px",boxShadow:"0 4px 20px rgba(0,0,0,0.15)"},children:S.jsx(mr,{pageType:qe,filters:u,onFilterChange:T,onClearFilters:w,totalCount:k.length})}),S.jsxs(dr,{ref:b,initialViewState:{longitude:-4.9,latitude:36.5,zoom:11},style:{width:"100%",height:"100%"},mapStyle:On,mapboxAccessToken:Mn,minZoom:9,attributionControl:!1,onLoad:Je,onMouseEnter:ar,onMouseLeave:lr,children:[S.jsxs(fr,{id:"properties",type:"geojson",data:V,cluster:!0,clusterMaxZoom:16,clusterRadius:60,children:[S.jsx(ze,{id:"clusters",type:"circle",filter:["has","point_count"],paint:{"circle-color":"#313131","circle-radius":["step",["get","point_count"],15,10,20,50,25],"circle-opacity":.9,"circle-stroke-width":2,"circle-stroke-color":"#fff"}}),S.jsx(ze,{id:"cluster-count",type:"symbol",filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":["DIN Offc Pro Medium","Arial Unicode MS Bold"],"text-size":12},paint:{"text-color":"#ffffff"}}),S.jsx(ze,{id:"unclustered-point",type:"circle",filter:["!",["has","point_count"]],paint:{"circle-color":"#000000","circle-radius":8,"circle-stroke-width":2,"circle-stroke-color":"#fff"}})]}),l&&S.jsx(pr,{longitude:l.longitude,latitude:l.latitude,anchor:"bottom",onClose:()=>c(null),closeButton:!1,closeOnClick:!1,offset:15,maxWidth:"300px",children:S.jsxs("div",{style:{padding:"0",display:"flex",flexDirection:"column",width:"280px"},children:[S.jsxs("div",{style:{position:"relative",height:"180px",width:"100%"},children:[S.jsx("img",{src:l.images&&l.images[0]||l.image||"https://via.placeholder.com/300x200?text=No+Image",alt:l.title,style:{width:"100%",height:"100%",objectFit:"cover",display:"block"}}),S.jsx("button",{onClick:h=>{h.stopPropagation(),m(l.id)},style:{position:"absolute",top:"8px",right:"8px",width:"32px",height:"32px",borderRadius:"50%",background:"rgba(255,255,255,0.9)",border:"none",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",boxShadow:"0 2px 8px rgba(0,0,0,0.1)"},children:S.jsx(Rt,{size:18,fill:f(l.id)?"red":"none",color:f(l.id)?"red":"#333"})})]}),S.jsxs("div",{style:{padding:"0.8rem 1rem"},children:[S.jsx("h3",{style:{margin:"0 0 4px 0",fontSize:"15px",fontWeight:600,color:"#1a1a1a",lineHeight:"1.2"},children:l.title||l.name||"Untitled"}),S.jsx("div",{style:{fontSize:"13px",color:"#666",marginBottom:"4px"},children:l.location?.name||l.address||"Unknown Location"}),S.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[S.jsx("div",{style:{fontSize:"16px",fontWeight:700,color:"#1a1a1a"},children:l.price?new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",maximumFractionDigits:0}).format(l.price):e("property.callForPrice")}),S.jsx("a",{href:`/${l.market==="rent"?"rent":l.market==="secondary"?"resale":"new-building"}/${l.id}`,target:"_blank",rel:"noopener noreferrer",style:{width:"32px",height:"32px",background:"#f5f5f5",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",color:"#1a1a1a",transition:"all 0.2s",cursor:"pointer"},className:"popup-link-btn",children:S.jsx(ht,{size:16})})]})]})]})})]}),n&&S.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",background:"white",padding:"1rem",borderRadius:"8px",zIndex:20},children:e("common.loading")}),S.jsx("button",{className:"draw-area-btn",onClick:ir,children:e(o?"map.clearArea":"map.drawArea")})]})}export{Bn as default};
